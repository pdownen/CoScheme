\allowdisplaybreaks

\adriano{Review the copattern case (probably use induction)}

\adriano{Figure out the correct argument to assure things about $\den{M}$'s}

\subsection{Conservative extension of the target}

\begin{restatable}{lemma}{thmvaluetranslation}
  \label{l-value}
  \label{thm:value-translation}
  The following instances of translation are all values up to the equational
  theory of the target language in \cref{fig:target-equality}:
  \begin{enumerate}[(a)]
  \item $T\den{B} = \lambda s. M$ for some term $M$,
  \item $E\den{O} = \lambda b. \lambda s. M$ for some term $M$,
  \item $E\den{F} = \lambda b. \lambda s. \lambda x. M$ for some term $M$,
  \item $\den{V} = W$ for some value $W$.
  \end{enumerate}
\end{restatable}
% \thmvaluetranslation*
\begin{proof}
  % The listed instances of translation are all values up to the equational theory of the target language in \cref{fig:target-equality}:

  % The proof follows
  By mutual induction on the syntax of templates $B$, extensions $O$, extension functions $F$, and values $V$.
  % By definition, we know that our translation returns terms in the target language.
  % In other words, we can say that $\den{M}=M'$ for some target term $M'$.
  \begin{enumerate}[(a)]
  \item $T\den{B} = \lambda s. M$ for some term $M$, as shown by the following cases:
    % \begin{proof}
    %   By induction on $B$.
    \begin{itemize}
    \item $(B = \varepsilon)$
      % By our translation we have:
      $T\den{\varepsilon} = \lambda s. ~\mathit{fail} ~s$, so $M=\mathit{fail} ~s$.
    \item ($B = O; B'$)
      $T\den{O; B'} = \lambda s. ~\den{O} ~\den{B'} ~s$, so $M = \den{O} ~\den{B'} ~s$.
      % By our translation we have: $T\den{O; B'} = \lambda s. ~\den{O} ~\den{B'} ~s$.
      % Our induction hypothesis provides us that $T\den{B'} = \lambda s. M'$ for some term $M'$.
      % % By (b) we know that $E\den{O}=\lambda b. \lambda s. M_O$ for some term $M_O$.
      % \begin{align*}
      %   & \quad \lambda s. ~\den{O} ~\den{B'} ~s \\
      %   % =& \quad \lambda s.  ~(\lambda b. \lambda s. M_O) ~(\lambda s. M') ~s & (IH, (b))
      %   =& \quad \lambda s. ~M_O ~(\lambda s. M') ~s & (IH)
      % \end{align*}
      % Where $M=M_O ~(\lambda s. M') ~s$.
    \item $(B = \Continue x {\,\to\,} N)$
      $T\den{\Continue x {\,\to\,} N} = \lambda x. \den{N}$, so $M = \den{N}$.
      % \begin{align*}
      %   & \quad T\den{\Continue x \to M'} = \lambda x. ~\den{M'} \\
      %   =& \quad \lambda x. ~(\lambda s. ~M'') \\
      %   =& \quad \lambda s. ~(\lambda s. ~M'') \subst{x}{s} & (=_{\alpha})
      % \end{align*} 
    \end{itemize}
    % \qed
    % \end{proof}
  \item $E\den{O} = \lambda b. \lambda s. M$ for some term $M$, as shown by the following cases: 
    % \begin{proof}
    %   By induction on $O$.
    \begin{itemize}
    \item $(O = \varepsilon)$
      % By our translation we have
      $E\den{\varepsilon} = \lambda b. \lambda s. ~b ~s$, so $M= b ~s$.
    \item $(O = O_1;O_2)$
      $E\den{O_1;O_2} = \lambda b. \lambda s. ~\den{O_1} ~(\den{O_2} ~b) ~s$, so $M = \den{O_1} ~(\den{O_2} ~b) ~s$.
      % \begin{align*}
      %   & \quad E\den{O_1;O_2} = \lambda b. \lambda s. ~\den{O_1} ~(\den{O_2} ~b) ~s\\
      %   =& \quad \lambda b. \lambda s. ~(\lambda b. \lambda s. ~M_{O_1}) ~((\lambda b. \lambda s. ~M_{O_2}) ~b) ~s & (IH)
      % \end{align*}
      % Where $M=(\lambda b. \lambda s. ~M_{O_1}) ~((\lambda b. \lambda s. ~M_{O_2}) ~b) ~s$.
    \item $(O = Q[x] ~O)$ follows by induction on $Q$ (generalizing $O$):
      \begin{itemize}
      \item $(Q=\hole)$ for all $O$,
        % According to our translation:
        \begin{align*}
          E\den{x ~O}
          &=
          \lambda b. \lambda x. E\den{O} ~ b ~ x
          \\
          &=
          \lambda b. \lambda s. E\den{O}\subst{x}{s} ~ b ~ s
          &(\alpha)
        \end{align*}
        so $M = E\den{O}\subst{x}{s} ~ b ~ s$ for the given $O$.
        % By our induction hypothesis we can infer that $E\den{O}=\lambda b. \lambda s. M_O$.
        % Therefore, we can conclude that $\lambda b. \lambda x. ~(\lambda b. \lambda s. M_O) ~ b ~ x$, where $ M = (\lambda b. \lambda s. M_O) ~ b ~ x$.
      \item $(Q=Q'~P)$
        assuming the inductive hypothesis (IH) that, for all $O$, there is an $N_O$ such that $E\den{Q[x] ~ O} = \lambda b. \lambda s. N_O$.
        For all $O$,
        \begin{align*}
          E\den{(Q'[x] ~ P) O}
          &=
          E\den{Q'[x] ~ (\lambda P. O)}
          \\
          &=
          \lambda b. \lambda s. N_{(\lambda P. O)}
          &(IH)
        \end{align*}
        so $M = N_{(\lambda P. O)}$ given by the inductive hypothesis applied to $\lambda P. O$.
        % According to our translation:
        % $E\den{(Q ~P) ~ [x] ~O} = E\den{(Q[x] ~P) ~O} = E\den{Q[x] ~ (\lambda P. O)}$.
        % Eventually, we will hit the previous case after converting all patterns in the copattern into pattern $\lambda$'s.
        % After converting all patterns $O$ will have a shape of form: $\lambda P_0. ~\lambda P_1 ... \lambda P_n. ~O$.
        % \adriano{I think I need to use induction here.}
      \end{itemize}
    \item $(O = \lambda P. ~O)$ follows by cases if $P$ is a variable or another pattern:
      \begin{itemize}
      \item $(P \in \mathit{Variable})$
        \begin{math}
          E\den{\lambda x. ~O}
          =
          \lambda b. \lambda s.
          (\lambda x. E\den{O} ~ (\lambda s'. b ~ s' ~ x) ~ s)
          ,
        \end{math}
        so
        \\
        $M = \lambda x. E\den{O} ~ (\lambda s'. b ~ s' ~ x) ~ s$.
      \item $(P \notin \mathit{Variable})$
      \begin{math}
        E\den{\lambda P. ~O}
        =
        E\den{\lambda x. \Match P \gets x ~ O}
        ,
      \end{math}
      which follows by the above case.
      \end{itemize}
      % According to our translation:
      % \begin{align*} 
      %   & \quad E\den{\lambda P. ~O} = E\den{\lambda x. \Match P \gets x ~ O}\\
      %   =& \quad \lambda b. \lambda s. (\lambda x. E\den{\Match P \gets x ~ O} ~ (\lambda s'. b ~ s' ~ x) ~ s) \\
      %   =& \quad \lambda b. \lambda s. (\lambda x. \lambda b. \lambda s. (
      %   \begin{aligned}[t]
      %     &\Match \den{M} \With \\
      %     &\quad
      %     \begin{aligned}[t]
      %       \{~
      %       P &\to E\den{O}~b~s; \\
      %       \_ &\to b~s
      %       ~\}
      %     \end{aligned}
      %   \end{aligned}
      %   )~ (\lambda s'. b ~ s' ~ x) ~ s) \\
      %   =& \quad \lambda b. \lambda s. (\lambda x. \lambda b. \lambda s. (
      %   \begin{aligned}[t]
      %     &\Match \den{M} \With \\
      %     &\quad
      %     \begin{aligned}[t]
      %       \{~
      %       P &\to (\lambda b. \lambda s. M_O)~b~s; \\
      %       \_ &\to b~s
      %       ~\}
      %     \end{aligned}
      %   \end{aligned}
      %   )~ (\lambda s'. b ~ s' ~ x) ~ s) & (IH)
      % \end{align*}
    \item $(O = \Match P \gets N ~ O)$
        \begin{align*}
          & \quad E\den{\Match P \gets N ~ O}
          =
          \lambda b. \lambda s.
          \begin{aligned}[t]
            &\Match \den{N} \With \\
            &\quad
            \begin{aligned}[t]
              \{~
              P &\to E\den{O}~b~s; \\
              \_ &\to b~s
              ~\}
            \end{aligned}
          \end{aligned}
          % \\
          % =& \quad \lambda b. \lambda s.
          % \begin{aligned}[t]
          %   &\Match \den{N} \With \\
          %   &\quad
          %   \begin{aligned}[t]
          %     \{~
          %     P &\to (\lambda b. \lambda s.~ M_O) ~b~s; \\
          %     \_ &\to b~s
          %     ~\}
          %   \end{aligned}
          % \end{aligned}  & (IH)
        \end{align*}
        so $M = \Match \den{N} \With \set{P \to E\den{O}~b~s; \_ \to b~s}$.
      \item $(O = \Nest O)$
        \begin{math}
          E\den{\Nest O}
          =
          \lambda b. \lambda s.
          (\Rec s' = E\den{O} ~ (\lambda \_. b ~ s) ~ (\lambda x. s' ~ x))
          ,
        \end{math}
        so $M = (\Rec s' = E\den{O} ~ (\lambda \_. b ~ s) ~ (\lambda x. s' ~ x))$
        % \begin{align*}
        %   & \quad E\den{\Nest O} = \lambda b. \lambda s. \Rec s' = E\den{O} ~ (\lambda \_. b ~ s) ~ (\lambda x. s' ~ x)\\
        %   =& \quad \lambda b. \lambda s. \Rec s' = (\lambda b. \lambda s.~ M_O) ~ (\lambda \_. b ~ s) ~ (\lambda x. s' ~ x) & (IH)
        % \end{align*}
      \item $(O = \Try x \to B)$
        assuming the inductive hypothesis $(IH)$ from part (a) that
        $T\den{B} = \lambda s. N$ for some $N$,
        \begin{align*}
          E\den{\Try x \to B}
          &= \lambda x. T\den{B}
          \\
          &= \lambda x. (\lambda s.~ N)
          & (IH)
          \\
          &=\lambda b. (\lambda s.~ N)\subst{x}{b}
          & (\alpha)
        \end{align*}
        so $M = N\subst{x}{b}$
    \end{itemize}
    % \qed
    % \end{proof}
  \item $E\den{F} = \lambda b. \lambda s. \lambda x. M$ for some term $M$, as shown by the following cases:
    % \begin{proof}
    %   Let us consider the possible values of $F$.
    \begin{itemize}
    \item $(F= \lambda P. ~O)$
      Following the same calculation in the matching special case of part (b) above,
      $E\den{\lambda P. O} = \lambda b. \lambda s. (\lambda x. M)$
      for some $M$.
    %   Let' consider if $P$ is a variable pattern or not:
    %   \begin{itemize}
    %   \item $(P = x)$ According to our translation $E\den{\lambda x. ~O}=\lambda b. \lambda s. (\lambda x. E\den{O} ~ (\lambda s'. b ~ s' ~ x) ~ s)$.
    %     Therefore, by (b), we can conclude that $\lambda b. \lambda s. (\lambda x. (\lambda b. \lambda s. M_O) ~ (\lambda s'. b ~ s' ~ x) ~ s)$
    %   \item $(P \neq x)$ We have that $E\den{\lambda P. ~O}=E\den{\lambda x. \Match P \gets x ~ O}$ which is a specific case of the previous case, where $O=\Match P \gets x ~ O$.
    %   \end{itemize} 
    \item $(F= Q[x ~P] ~O)$
      follows by induction on $Q$ (generalizing $O$):
      \begin{itemize}
      \item $(Q = \hole)$ for all $O$,
        \begin{align*}
          E\den{(y ~ P) ~ O}
          =
          E\den{y ~ (\lambda P. O)}
          &=
          \lambda b. \lambda y. E\den{\lambda P. O} ~ b ~ y
          % \\
          % &=
          % \lambda b. \lambda s. E\den{\lambda P. O}\subst{y}{s} ~ b ~ s
          % &(\alpha)
        \end{align*}
        Following the same calculation in the previous case $(F = \lambda P. O)$ gives us
        some $N$ such that $E\den{\lambda P. O} = \lambda b. \lambda s'. \lambda x. N$, so continuing we have
        \begin{align*}
          E\den{(y ~ P) ~ O}
          &=
          \lambda b. \lambda y. (\lambda b. \lambda s'. \lambda x. N) ~ b ~ y
          \\
          &=
          \lambda b. \lambda y. \lambda x. N\subst{s'}{y}
          &(\beta)
          \\
          &=
          \lambda b. \lambda s. \lambda x. N\subst{s'}{y}\subst{y}{s}
          &(\alpha)
        \end{align*}
        so $M = N\subst{s'}{y}\subst{y}{s}$.
      \item $(Q = Q' ~ P')$
        assuming the inductive hypothesis that,
        for all $O$, there is an $N_O$ such that
        $E\den{Q'[y ~ P] ~ O} = \lambda b. \lambda s. \lambda x. N_O$.
        For all $O$,
        \begin{align*}
          E\den{(Q'[y ~ P] ~ P') ~ O}
          &=
          E\den{Q'[y ~ P] ~ (\lambda P'. O)}
          \\
          &=
          \lambda b. \lambda s. \lambda x. N_{(\lambda P'. O)}
          &(IH)
        \end{align*}
        so $M = N_{(\lambda P'. O)}$ given by the inductive hypothesis applied to $\lambda P'. O$.
      \end{itemize}
      % Eventually, after converting the whole copattern we will hit $E\den{x ~O}$, where $O$ is some sequence of nested $\lambda P$'s.
      % \begin{align*}
      %   & \quad E\den{x ~O} =  \lambda b. \lambda x. E\den{\lambda P. O'} ~ b ~ x\\
      %   =& \quad \lambda b. \lambda x. (\lambda b. \lambda s. \lambda x. M') ~ b ~ x & (IH) \\
      %   =& \quad \lambda b. \lambda x. (\lambda x. M'\subst{s}{x}) & (\beta) \\
      %   =& \quad \lambda b. \lambda s. (\lambda x. M'\subst{s}{x})\subst{x}{s} & (\alpha)
      % \end{align*}
    \end{itemize}
    % \qed
    % \end{proof}
  \item $\den{V} = W$ for some value $W$, as shown by the following cases:
    % \begin{proof}
    %   By induction on $V$.
    \begin{itemize}
    \item $(V = x)$
      $\den{x} = x$, so $W=x$.
    \item $(V = \lambda x. M)$
      $\den{\lambda x. M} = \lambda x. \den{M}$, so $W = \lambda x. \den{M}$.
    \item $(V = \Null)$
      $\den{\Null} = \Null$, so $W=\Null$.
    \item $(V = \Cons V_1 ~ V_2)$
      $\den{\Cons V_1 ~ V_2} = \Cons \den{V_1} ~ \den{V_2}$,
      where $\den{V_1} = W_1$ and $\den{V_2} = W_2$ by the inductive hypotheses,
      so $W = \Cons W_1 ~ W_2$.
    \item $(V = \Template B)$
      $\den{\Template B} = T\den{B} = \lambda s. M$, for some $M$,
      by the inductive hypothesis part (a),
      so $W = \lambda s. M$.
    \item $(V = \Extension O)$
      $\den{\Extension O} = E\den{O} = \lambda b. \lambda s. M$, for some $M$,
      by the inductive hypothesis part (b),
      so $W = \lambda b. \lambda s. M$.
    \item $(V = \lamstar (F; B))$
      assuming the inductive hypotheses that 
      \begin{itemize}
      \item[$IH_1$] there is some $N_1$ such that
        $E\den{F} = \lambda b. \lambda s. \lambda x. N_1$, and
      \item[$IH_2$] there is some $N_2$ such that
        $T\den{B} = \lambda s. N_2$,
      \end{itemize}
      \begin{align*}
        \den{\lamstar (F; B)}
        &=
        (\Rec \mathit{self} = T\den{F; B} ~ (\lambda x. \mathit{self} ~ x))
        \\
        &=
        (\Rec \mathit{self} = E\den{F} ~ T\den{B} ~ (\lambda x. \mathit{self} ~ x))
        &(\beta)
        \\
        &=
        (\Rec \mathit{self}
        = (\lambda b. \lambda s. \lambda x. N_1)
        ~ T\den{B}
        ~ (\lambda x. \mathit{self} ~ x))
        &(IH_1)
        \\
        &=
        (\Rec \mathit{self}
        = (\lambda b. \lambda s. \lambda x. N_1)
        ~ (\lambda s. N_2)
        ~ (\lambda x. \mathit{self} ~ x))
        &(IH_2)
        \\
        &=
        (\Rec \mathit{self}
        = \lambda x.N_1\subst{b}{(\lambda s.N_2)}\subst{s}{(\lambda x.\mathit{self}~x)})
        &(\beta)
        \\
        &=
        \begin{aligned}[t]
          \lambda x.
          N_1
          &\subst{b}{(\lambda s.N_2)}
          \\
          &\subst{s}{(\lambda x.\mathit{self}~x)}
          \\
          &\subst
          {\mathit{self}}
          {
            (\Rec \mathit{self}
            =
            \lambda x.N_1\subst{b}{(\lambda s.N_2)}\subst{s}{(\lambda x.\mathit{self}~x)})
          }
        \end{aligned}
        &(rec)
      \end{align*}
    % \qed
    % \end{proof}
    \end{itemize}
  \end{enumerate}
\end{proof}

\begin{lemma}[Substitution]
  \label{thm:substitution-translation}
  For all values $V$,
  \begin{enumerate}[(a)]
  \item $\den{M\subst{x}{V}} = \den{M}\subst{x}{\den{V}}$,
  \item $T\den{B\subst{x}{V}} = T\den{B}\subst{x}{\den{V}}$,
  \item $E\den{O\subst{x}{V}} = E\den{O}\subst{x}{\den{V}}$.
  \end{enumerate}
\end{lemma}
\begin{proof}
  By mutual induction on the syntax of terms $M$, tempaltes $B$, and extensions $O$.
\end{proof}

\begin{lemma}[Compositionality]
  \label{thm:compositional-translation}

  There exists a translation of contexts $\den{C}$ such that
  $\den{C[M]} = \den{C}{[\den{M}]}$.
\end{lemma}
\begin{proof}
  By induction on the context $C$.
\end{proof}

\thmconservativeextension*
\begin{proof}
  The proof strategy follows from proposition 1 of \cite{DownenAriola2014CSCC}.
  
  Reflexivity, transitivity, and symmetry of the equational theory follows immediately.

  Congruence---$M = N$ implies $C[M] = C[N]$ for all contexts $C$---follows from
  the fact that the translation is \emph{compositional}
  (\cref{thm:compositional-translation}).  An equation $C[M] = C[N]$, derived
  from congruence of $M = N$ inside $C$, can be derived by distributing the
  translation across contexts to apply the underlying equality
  $\den{M} = \den{N}$ gotten from soundness of $M = N$:
  \begin{align*}
    \den{C[M]}
    &=
    \den{C}{[\den{M}]}
    &(\cref{thm:compositional-translation})
    \\
    &=
    \den{C}{[\den{N}]}
    \\
    &=
    \den{C[N]}
    &(\cref{thm:compositional-translation})
  \end{align*}

  Finally, each individual axiom ($\beta$, $rec$, \etc) from the target language
  immediately holds by the inductive hypothesis---because the definition of
  translation for these cases does not change syntax---along with
  \cref{thm:value-translation,thm:substitution-translation} for cases which
  substitute.  For example, with the $\beta$ axiom, we have
  \begin{align*}
    \den{(\lambda x. M) ~ V}
    &=
    (\lambda x. \den{M}) ~ \den{V}
    \\
    &=
    (\lambda x. \den{M}) ~ W
    &(\cref{thm:value-translation})
    \\
    &=
    \den{M}\subst{x}{W}
    &(\beta)
    \\
    &=
    \den{M}\subst{x}{\den{V}}
    &(\cref{thm:value-translation})
    \\
    &=
    \den{M\subst{x}{V}}
    &(\cref{thm:substitution-translation})
  \end{align*}
  since values are only translated to values, $\den{V} = W$ up to the target equational theory (\cref{thm:value-translation}), which means that $\beta$-reduction still applies after translation.
\end{proof}

\subsection{Soundness of the source}

\begin{lemma}[Pattern Translation]
  \label{thm:pattern-translation}

  $\den{P} = P$.
\end{lemma}
\begin{proof}
  By induction on the syntax of $P$.
\end{proof}

\begin{lemma}[Apartness Translation]
  \label{thm:apartness-translation}

  If $P \apart V$ then $P \apart \den{V}$.
\end{lemma}
\begin{proof}
  By induction on the derivation of apartness $P \apart V$.
\end{proof}

\thmsoundness*
\begin{proof}
  Each axiom is derived up to the target equational theory in the following lemmas.
\end{proof}

\begin{lemma}[Extension Composition Identity Left]
  \label{thm:ext-compose-id-left}
    $ E\den{\varepsilon; O} = E\den{O}.$
\end{lemma}
    \begin{proof}
        \begin{align*}
            &\quad E\den{\varepsilon; O} \\
            =& \quad \lambda b. \lambda s.~ E\den{\varepsilon} ~(E\den{O} ~b) ~s \\
            =&  \quad \lambda b. \lambda s.~ E\den{\varepsilon} ~((\lambda b. \lambda s.~ M_0) ~b) ~s & (\cref{l-value})\\
            =& \quad \lambda b. \lambda s.~ (\lambda b. \lambda s.~ b ~s) ~((\lambda b. \lambda s.~ M_0) ~b) ~s \\
            =& \quad \lambda b. \lambda s.~ (\lambda b. \lambda s.~ b ~s) ~(\lambda s.~ M_0) ~s & (\beta)\\
            =& \quad \lambda b. \lambda s.~ (\lambda s.~ (\lambda s.~ M_0) ~s) ~s & (\beta)\\
            =& \quad \lambda b. \lambda s.~ (\lambda s.~ M_0) ~s & (\beta)\\
            =& \quad \lambda b. \lambda s.~ M_0 & (\beta) \\
            =& \quad E\den{O} & (\cref{l-value})
        \end{align*}
        \qed
    \end{proof}

%% Paul: Removing this lemma since it is the only one that requires eta.
    
% \begin{lemma}[Extension Composition Identity Right]
%   \label{thm:ext-compose-id-right}
%   $ E\den{O} = E\den{O;\varepsilon}.$
% \end{lemma}
%     \begin{proof}
%         \begin{align*}
%             &\quad E\den{O;\varepsilon} \\
%             =& \quad \lambda b. \lambda s.~ E\den{O} ~(E\den{\varepsilon} ~b) ~s \\
%             =& \quad \lambda b. \lambda s.~ E\den{O} ~((\lambda b. \lambda s.~ b ~s) ~b) ~s \\
%             =& \quad \lambda b. \lambda s.~ E\den{O} ~(\lambda s.~ b ~s) ~s & (\beta)\\
%             =& \quad \lambda b. \lambda s.~ (\lambda b. \lambda s.~ M_0) ~(\lambda s.~ b ~s) ~s & (\cref{l-value})\\
%             =& \quad \color{red}{\lambda b. \lambda s.~ (\lambda b. \lambda s.~ M_0) ~b ~s} & \color{red}{(\eta)}\\
%             =& \quad \color{red}{\lambda b. \lambda s.~ (\lambda s.~ M_0) ~s} & (\beta)\\
%             =& \quad \color{red}{\lambda b. \lambda s.~ M_0} & (\beta) \\
%             =& \quad \color{red}{E\den{O}} & (\cref{l-value})
%         \end{align*}
%         \qed
%     \end{proof}

\begin{lemma}[Template Composition Identity Left]
  \label{thm:tmpl-compose-id-left}
  $ T\den{\varepsilon; B} = T\den{B}.$
\end{lemma}
    \begin{proof}
        \begin{align*}
            &\quad T\den{\varepsilon; B} \\
            =& \quad \lambda s. ~ E\den{\varepsilon} ~T\den{B} ~s \\
            =& \quad \lambda s. ~ (\lambda b. \lambda s.~ b ~s) ~T\den{B} ~s \\
            =& \quad \lambda s. ~ T\den{B} ~s & (\beta, \cref{thm:value-translation})\\
            =& \quad T\den{B} & (\alpha, \beta, \cref{l-value})
        \end{align*}
        \qed
    \end{proof}

\begin{lemma}[Extension Composition Associativity]
  \label{thm:ext-compose-assoc}

  $ E\den{(O_1;O_2);O_3} = E\den{O_1;(O_2;O_3)}.$
\end{lemma}
\begin{proof}
  The left-hand side simplifies as follows:
  \begin{align*}
    &\quad E\den{(O_1;O_2);O_3} \\
    =& \quad \lambda b. \lambda s.~ E\den{O_1;O_2} ~(E\den{O_3} ~b) ~s \\
    =& \quad \lambda b. \lambda s.~ (\lambda b. \lambda s.~ E\den{O_1} ~(E\den{O_2} ~b) ~s) ~(E\den{O_3} ~b) ~s \\
    =& \quad \lambda b. \lambda s.~ (\lambda b. \lambda s.~ (\lambda b. \lambda s. M_1) ~((\lambda b. \lambda s. M_2) ~b) ~s) ~((\lambda b. \lambda s. M_3) ~b) ~s & (\cref{l-value}) \\
    =& \quad \lambda b. \lambda s.~ (\lambda b. \lambda s.~ (\lambda b. \lambda s. M_1) ~((\lambda b. \lambda s. M_2) ~b) ~s) ~(\lambda s. M_3) ~s & (\beta) \\
    =& \quad \lambda b. \lambda s.~ (\lambda b. \lambda s. M_1) ~((\lambda b. \lambda s. M_2) ~(\lambda s. M_3)) ~s & (\beta) \\
    =& \quad \lambda b. \lambda s.~ (\lambda b. \lambda s. M_1) ~(\lambda s. M_2\subst{b}{(\lambda s. M_3)}) ~s & (\beta) \\
    \\
    =& \quad \lambda b. \lambda s.~ M_1\subst{b}{(\lambda s. M_2\subst{b}{(\lambda s. M_3)})} & (\beta) \\
  \end{align*}
  The right-hand side simplifies to the same term as follows:
  \begin{align*}
    &\quad E\den{O_1;(O_2;O_3)} \\
    =& \quad \lambda b. \lambda s.~ E\den{O_1} ~(\den{O_2;O_3} ~b) ~s \\
    =& \quad \lambda b. \lambda s.~ E\den{O_1} ~((\lambda b. \lambda s.~ E\den{O_2} ~(E\den{O_3} ~b) ~s) ~b) ~s \\
    =& \quad \lambda b. \lambda s.~ E\den{O_1} ~(\lambda s.~ E\den{O_2} ~(E\den{O_3} ~b) ~s) ~s & (\beta)\\
    =& \quad \lambda b. \lambda s.~ (\lambda b. \lambda s. M_1) ~(\lambda s.~ (\lambda b. \lambda s. M_2) ~((\lambda b. \lambda s. M_3) ~b) ~s) ~s & (\cref{l-value}) \\
    =& \quad \lambda b. \lambda s.~ (\lambda b. \lambda s. M_1) ~(\lambda s.~ (\lambda b. \lambda s. M_2) ~(\lambda s. M_3) ~s) ~s & (\beta) \\
    =& \quad \lambda b. \lambda s.~ (\lambda b. \lambda s. M_1) ~(\lambda s. M_2\subst{b}{(\lambda s. M_3)}) ~s & (\beta) \\
    =& \quad \lambda b. \lambda s.~ M_1\subst{b}{(\lambda s. M_2\subst{b}{(\lambda s. M_3)})} & (\beta)
  \end{align*}
  \qed
\end{proof}

\begin{lemma}[Template Composition Associativity]
  \label{thm:templ-compose-assoc}

  $ T\den{(O_1;O_2);B} = T\den{O_1;(O_2;B)}.$
\end{lemma}
\begin{proof}
  The left-hand side simplifies as follows:
  \begin{align*}
    &\quad T\den{(O_1;O_2);B} \\
    =& \quad \lambda s.~ E\den{O_1;O_2} ~T\den{B} ~s \\
    =& \quad \lambda s.~ (\lambda b. \lambda s.~ E\den{O_1} ~(E\den{O_2} ~b) ~s) ~T\den{B} ~s \\
    =& \quad \lambda s.~ E\den{O_1} ~(E\den{O_2} ~T\den{B}) ~s & (\beta, \cref{thm:value-translation}) \\
    =& \quad \lambda s.~ (\lambda b.\lambda s. M_1) ~((\lambda b. \lambda s. M_2) ~T\den{B}) ~s & (\cref{l-value}) \\
    =& \quad \lambda s.~ (\lambda b.\lambda s. M_1) ~(\lambda s. M_2\subst{b}{T\den{B}}) ~s & (\beta, \cref{thm:value-translation}) \\
    =& \quad \lambda s.~ M_1\subst{b}{(\lambda s. M_2\subst{b}{T\den{B}})} & (\beta) \\
  \end{align*}
  The right-hand side simplifies to the same term as follows:
  \begin{align*}
    &\quad T\den{O_1;(O_2;B)} \\
    =& \quad \lambda s.~ E\den{O_1} ~T\den{O_2;B} ~s \\
    =& \quad \lambda s.~ E\den{O_1} ~(\lambda s. ~E\den{O_2} ~T\den{B} ~s) ~s \\
    =& \quad \lambda s.~ (\lambda b. \lambda s. M_1) ~(\lambda s. ~(\lambda b. \lambda s.~ M_2) ~T\den{B} ~s) ~s & (\cref{l-value}) \\
    =& \quad \lambda s.~ (\lambda b. \lambda s. M_1) ~(\lambda s. M_2\subst{b}{T\den{B}}) ~s & (\beta, \cref{thm:value-translation}) \\
    =& \quad \lambda s.~ M_1\subst{b}{(\lambda s. M_2\subst{b}{T\den{B}})} & (\beta) \\
  \end{align*}
  \qed
\end{proof}

\begin{lemma}[Extension Commit]
  \label{thm:ext-commit}
  $ E\den{\Do M; O} = E\den{\Do M}.$
\end{lemma}
\begin{proof}
  \begin{align*}
    &\quad
    E\den{\Do M; O}
    \\
    =& \quad
    \lambda b. \lambda s.~ E\den{\Do M} ~(E\den{O} ~b) ~s
    \\
    =& \quad
    \lambda b. \lambda s.~ E\den{\Do M} ~((\lambda b. \lambda s.~ M_O) ~b) ~s
    & (\cref{l-value})
    \\
    =& \quad
    \lambda b. \lambda s.~ E\den{\Do M} ~(\lambda s.~ M_O) ~s
    & (\beta)
    \\
    =& \quad
    \lambda b. \lambda s.~ E\den{\Try \_ \to \Continue \_ \to M} ~(\lambda s.~ M_O) ~s
    \\
    =& \quad
    \lambda b. \lambda s.~ (\lambda \_. ~T\den{\Continue \_ \to M}) ~(\lambda s.~ M_O) ~s
    \\
    =& \quad
    \lambda \_. \lambda s.~ T\den{\Continue \_ \to M} ~s
    & (\beta, b \notin FV(M))
    \\
    =& \quad
    \lambda \_. \lambda s.~ (\lambda \_. ~ \den{M}) ~s
    \\
    =& \quad
    \lambda \_. \lambda \_.~ \den{M}
    & (\beta, s \notin FV(M))
    \\
    =& \quad
    \lambda \_. ~T\den{\Continue \_ \to M}
    \\
    =&\quad
    E\den{\Try \_ \to \Continue \_ \to M}
    \\
    =&\quad
    E\den{\Do M}
  \end{align*}
  \qed
\end{proof}

\begin{lemma}[Template Commit]
  \label{thm:template-commit}
  $ T\den{\Do M; B} = T\den{\Else M}.$
\end{lemma}
\begin{proof}
  \begin{align*}
    &\quad
    T\den{\Do M; B}
    \\
    =& \quad
    \lambda s. ~ E\den{\Do M} ~T\den{B} ~s
    \\
    =& \quad
    \lambda s. ~ E\den{\Try \_ \to \Continue \_ \to M} ~T\den{B} ~s
    \\
    =& \quad
    \lambda s. ~ (\lambda \_. ~T\den{\Continue \_ \to M}) ~T\den{B} ~s
    \\
    =& \quad
    \lambda s. ~ (\lambda \_. ~\lambda \_. ~  \den{M}) ~T\den{B} ~s
    \\
    =& \quad
    \lambda s. ~ (\lambda \_. ~  \den{M}) ~s
    & (\beta)
    \\
    =& \quad
    \lambda \_. ~ \den{M}
    & (\beta, s \notin FV(M))
    \\
    =& \quad
    T\den{\Continue \_ \to M}
    \\
    =& \quad
    T\den{\Else M}
  \end{align*}
  \qed
\end{proof}

\begin{lemma}[$\eta\lamstar$]
  \label{thm:eta-lamstar}
  $E\den{\lambda x.~ (\lamstar (F; B)) ~ x} = E\den{\lamstar (F; B)}$
\end{lemma}
\begin{proof}
  From \cref{thm:value-translation}, we have
  $E\den{F} = \lambda b.\lambda s. \lambda z. M$ for some term $M$.  In the
  following, let
  $M' = M\subst{b}{T\den{B}}\subst{s}{(\lambda y.\mathit{self}~y)}$,
  \begin{align*}
    &\quad
    E\den{\lambda x.~ (\lamstar (F; B)) ~ x}
    \\
    =&\quad
    \lambda x. E\den{(\lamstar (F; B))} ~ x
    \\
    =&\quad
    \lambda x.
    (\Rec \mathit{self}
    = (\lambda s. E\den{F} ~ T\den{B} ~ s)
    ~ (\lambda y. \mathit{self}~y))
    ~ x
    \\
    =&\quad
    \lambda x.
    (\Rec \mathit{self} = E\den{F} ~ T\den{B} ~ (\lambda y. \mathit{self}~y))
    ~ x
    &(\beta)
    \\
    =&\quad
    \lambda x.
    (\Rec \mathit{self}
    = (\lambda b.\lambda s.\lambda z. M) ~ T\den{B}
    ~ (\lambda y. \mathit{self}~y))
    ~ x
    &(\cref{thm:value-translation})
    \\
    =&\quad
    \lambda x.
    (\Rec \mathit{self}
    = \lambda z. M\subst{b}{T\den{B}}\subst{s}{(\lambda y.\mathit{self}~y)})
    ~ x
    \\
    =&\quad
    \lambda x.
    (\Rec \mathit{self} = \lambda z. M')
    ~ x
    &(\beta)
    \\
    =&\quad
    \lambda x.
    (\lambda z.
    M'
    \subst{\mathit{self}}{\Rec \mathit{self} = \lambda z. M'})
    ~ x
    &(rec)
    \\
    =&\quad
    \lambda x.
    M'
    \subst{\mathit{self}}{\Rec \mathit{self} = \lambda z. M'}
    \subst{z}{x}
    &(\beta)
    \\
    =&\quad
    \lambda z.
    M'
    \subst{\mathit{self}}{\Rec \mathit{self} = \lambda z. M'}
    &(\alpha)
    \\
    =&\quad
    \Rec \mathit{self} = \lambda z. M'
    &(rec)
    \\
    =&\quad
    \Rec \mathit{self}
    = \lambda z. M\subst{b}{T\den{B}}\subst{s}{(\lambda y.\mathit{self}~y)}
    \\
    =&\quad
    \Rec \mathit{self}
    = (\lambda b. \lambda s. \lambda z. M) ~ T\den{B}
    ~ (\lambda x. \mathit{self} ~ x)
    &(\beta)
    \\
    =&\quad
    \Rec \mathit{self} = E\den{F} ~ T\den{B} ~ (\lambda x. \mathit{self} ~ x)
    &(\cref{thm:value-translation})
    \\
    =&\quad
    \Rec \mathit{self}
    = (\lambda s. E\den{F} ~ T\den{B} ~ s)
    ~ (\lambda x. \mathit{self} ~ x)
    &(\beta)
    \\
    =&\quad
    \Rec \mathit{self} = T\den{F; B} ~ (\lambda x. \mathit{self} ~ x)
    \\
    =&\quad
    E\den{\lamstar(F; B)}
  \end{align*}
  \qed
\end{proof}

\begin{lemma}[Unfold $\lamstar$]
  \label{thm:unfold-lamstar}
    $ E\den{ \lamstar (F; B)} = \den{(\Template F; B) ~ (\lamstar (F; B))}.$
\end{lemma}
\begin{proof}
  Note,
  \begin{math}
    T\den{F; B} ~ (\lambda x. \mathit{self} ~ x)
    =
    E\den{F} ~ T\den{B} ~ (\lambda x. \mathit{self} ~ x)    
  \end{math}
  is $\beta$-equal to some value of the form $\lambda z. M'$ because
  $T\den{F; B} = \lambda b. \lambda s. \lambda z. M$ from
  \cref{thm:value-translation}.  So
  $\Rec \mathit{self} = T\den{F; B} ~ (\lambda x. \mathit{self} ~ x)$ unfolds
  via $\beta$ and $rec$ in the following,
  \begin{align*}
    &\quad
    E\den{ \lamstar (F; B)}
    \\
    =& \quad
    (\Rec \mathit{self} = T\den{F; B} ~ (\lambda x. \mathit{self} ~ x))
    \\
    =& \quad
    T\den{F; B}
    ~
    (\lambda x.
    (\Rec \mathit{self} = T\den{F; B} ~ (\lambda x. \mathit{self} ~ x))
    ~ x)
    )
    & (\beta, rec)
    \\
    =& \quad
    T\den{F; B} ~ (\lambda x. \den{\lamstar(F; B)} ~ x)
    \\
    =& \quad
    T\den{F; B} ~ \den{\lamstar(F; B)}
    & (\cref{thm:eta-lamstar})
    \\
    =& \quad
    \den{\Template (F; B)} ~ \den{\lamstar (F; B)}
    \\
    =& \quad
    \den{(\Template (F; B)) ~ (\lamstar (F; B))}
  \end{align*}
  \qed
\end{proof}

\begin{lemma}[Template Extension]
  \label{thm:templ-ext}

  $ \den{(\Template O; B) ~ V} = \den{(\Extension O) ~ (\Template B) ~ V}.$
\end{lemma}
\begin{proof}
  \begin{align*}
    &\quad \den{(\Template O; B) ~ V} \\
    =& \quad \den{(\Template O; B)} ~ \den{V} \\
    =& \quad (\lambda s. ~E\den{O} ~T\den{B} ~s) ~ \den{V} \\
    =& \quad E\den{O} ~T\den{B} ~ \den{V} & (\beta, \cref{thm:value-translation}) \\
    =& \quad E\den{\Extension O} ~T\den{\Template B} ~ \den{V} \\
    =& \quad E\den{(\Extension O) ~ (\Template B) ~ V}
  \end{align*}
  \qed
\end{proof}

\begin{lemma}[Template Failure]
  \label{thm:templ-fail}
  $ \den{(\Template \varepsilon) ~ V} = \den{\mathit{fail}~V}.$
\end{lemma}
    \begin{proof}
        \begin{align*}
            &\quad \den{(\Template \varepsilon) ~ V} \\
            =& \quad \den{(\Template \varepsilon)} ~ \den{V}\\
            =& \quad T\den{\varepsilon} ~ \den{V} \\
            =& \quad (\lambda s. \mathit{fail} ~ s) ~ \den{V} \\
            =& \quad \mathit{fail} ~ \den{V} &(\beta, \cref{thm:value-translation}) \\
            =& \quad \den{\mathit{fail} ~ V}
        \end{align*}
        \qed
    \end{proof}

\begin{lemma}[Template Continue]
  \label{thm:templ-continue}
  
  $ \den{(\Template \Continue x \to M) ~ V} = \den{M\subst{x}{V}}.$
\end{lemma}
\begin{proof}
  \begin{align*}
    &\quad \den{(\Template \Continue x \to M) ~ V} \\
    =& \quad T\den{(\Continue x \to M)} ~ \den{V}\\
    =& \quad (\lambda x. ~\den{M}) ~ \den{V} \\
    =& \quad \den{M}\subst{x}{\den{V}} & (\beta, \cref{thm:value-translation}) \\
    =& \quad \den{M\subst{x}{V}} &(\cref{thm:substitution-translation})
  \end{align*}
  \qed
\end{proof}

\begin{lemma}[Extension Try]
  \label{thm:ext-try}
  
  $ \den{(\Extension \Try x \to B) ~ V} = \Template B\subst{x}{V}.$
\end{lemma}
\begin{proof}
  \begin{align*}
    &\quad \den{(\Extension \Try x \to B) ~ V}  \\
    =& \quad \den{(\Extension \Try x \to B)} ~ \den{V}\\
    =& \quad E\den{(\Try x \to B)} ~ \den{V}\\
    =& \quad (\lambda x. ~T\den{B}) ~ \den{V}\\
    =& \quad T\den{B}\subst{x}{\den{V}} &(\beta, \cref{thm:value-translation}) \\
    =& \quad T\den{B\subst{x}{V}} &(\cref{thm:substitution-translation}) \\
    =& \quad \den{\Template B\subst{x}{V}}
  \end{align*}
  \qed
\end{proof}

\begin{lemma}[Try Match]
  \label{thm:try-match}

  $\den{\Match P \gets V ~ O} = \den{O\subst{\many{x}}{\many{W}}}
  \qquad (\text{if } P\subst{\many{x}}{\many{W}} = V).$
\end{lemma}
\begin{proof}
  By \cref{thm:substitution-translation,thm:pattern-translation},
  \begin{math}
    \den{V}
    =
    \den{P\subst{\many{x}}{\many{W}}}
    =
    \den{P}\subst{\many{x}}{\many{\den{W}}}
    =
    P\subst{\many{x}}{\many{\den{W}}}
  \end{math}
  in the following:
  \begin{align*}
    &\quad \den{\Match P \gets V ~ O}  \\
    =&\quad \lambda b. \lambda s. \Match \den{V} \With \set{P \to E\den{O}~b~s; \_ \to b~s} \\
    =&\quad  \lambda b. \lambda s.~E\den{O}\subst{\many{x}}{\many{\den{W}}}~b~s  & (match, \cref{thm:substitution-translation,thm:pattern-translation}) \\
    =& \quad \lambda b. \lambda s.~E\den{O\subst{\many{x}}{\many{W}}}~b~s & (\cref{thm:substitution-translation})
    \\
    =& \quad E\den{O\subst{\many{x}}{\many{W}}} & (\alpha, \beta, \cref{thm:value-translation})
  \end{align*}
  \qed
\end{proof}

\begin{lemma}[Try Match Apart]
  \label{thm:try-match-apart}

  $\den{\Match P \gets V ~ O} = \den{\varepsilon}
  \qquad (\text{if } P \apart V).$
\end{lemma}
\begin{proof}
  By \cref{thm:apartness-translation}, $P \apart \den{V}$ in the following:
  \begin{align*}
    &\quad \den{\Match P \gets V ~ O}  \\
    =&\quad \lambda b. \lambda s. \Match \den{V} \With \set{P \to E\den{O}~b~s; \_ \to b~s} \\
    =&\quad  \lambda b. \lambda s.~b~s  & (apart, \cref{thm:apartness-translation}) \\
    =& \quad E\den{\varepsilon}
  \end{align*}
  \qed
\end{proof}

\begin{lemma}[Template Match]
  \label{thm:template-match}
  \begin{align*}
    \den{\Template{} (\lambda P. O; B) ~ V' ~ V}
    &=
    \denbig{
      \left(
        \begin{aligned}
          &\Template{} \\
          &\quad O\subst{\many{x}}{\many{W}}; \\
          &\quad \Continue s' \to (\Template B) ~ s' ~ V
        \end{aligned}
      \right)
      ~ V'
    }
    \\
    &
    (\text{if } P\subst{\many{x}}{\many{W}} = V)
    .
  \end{align*}
\end{lemma}
\begin{proof}
  By cases on whether $P$ is a variable or not:
  \begin{itemize}
  \item If $P = y$, then $P\subst{\many{x}}{\many{W}} = y\subst{y}{V}$ with $\many{x} = y$ and $\many{W}=V$ and:
  \begin{align*}
    &\quad
    \den{(\Template{} (\lambda y. O); B) ~ V' ~ V}
    \\
    =&\quad (\lambda s. E\den{\lambda y. O} ~T\den{B} ~s) ~\den{V'} ~\den{V}
    \\
    =&\quad
    E\den{\lambda y. \Do M} ~T\den{B} ~\den{V'} ~\den{V}
    & (\beta, \cref{thm:value-translation})
    \\
    =&\quad
    (\lambda b. \lambda s. \lambda y. E\den{O} ~(\lambda s'. b ~s' ~y) ~s) ~T\den{B} ~\den{V'} ~\den{V}
    \\
    =&\quad
    E\den{O}\subst{y}{\den{V}} ~(\lambda s'. T\den{B} ~s' ~\den{V}) ~\den{V'}
    & (\beta, \cref{thm:value-translation})
    \\
    =&\quad
    E\den{O\subst{y}{V}} ~ (\lambda s'. T\den{B} ~ s' ~ \den{V}) ~ \den{V'}
    &(\cref{thm:substitution-translation})
    \\
    =&\quad
    \denbig{
      \left(
        \begin{aligned}
          \Template{}
          & O\subst{y}{V}; \\
          &\Continue s' \to (\Template B) ~ s' ~ V
        \end{aligned}
      \right)
      ~ V'
    }
    & (\beta, \cref{thm:value-translation})
  \end{align*}
  \item Otherwise, by \cref{thm:substitution-translation,thm:pattern-translation},
  \begin{math}
    \den{V}
    =
    \den{P\subst{\many{x}}{\many{W}}}
    =
    \den{P}\subst{\many{x}}{\many{\den{W}}}
    =
    P\subst{\many{x}}{\many{\den{W}}}
  \end{math}
  in the following:
  \begin{align*}
    &\quad
    \den{(\Template{} (\lambda P. O); B) ~ V' ~ V}
    \\
    =&\quad
    (\lambda s. E\den{\lambda P. O} ~T\den{B} ~s) ~\den{V'} ~\den{V}
    \\
    =&\quad
    E\den{\lambda P. O} ~T\den{B} ~\den{V'} ~\den{V}
    & (\beta,\cref{thm:value-translation})
    \\
    =&\quad
    E\den{\lambda y. \Match P \gets y ~ O} ~T\den{B} ~\den{V'} ~\den{V}
    \\
    =&\quad
    E\den{\Match P \gets y ~ O}\subst{y}{\den{V}} ~(\lambda s'. T\den{B} ~s' ~\den{V}) ~\den{V'}
    & (\beta, \cref{thm:value-translation})
    \\
    =&\quad
    \begin{aligned}[t]
      &\Match \den{V} \With{} \{ \\
      &\quad P \to E\den{O}~(\lambda s'. T\den{B} ~s' ~\den{V})~\den{V'}; \\
      &\quad\_ \to (\lambda s'. T\den{B} ~s' ~\den{V}) ~ \den{V'}
      ~\}
    \end{aligned}
    &(\beta, \cref{thm:value-translation})
    \\
    =&\quad E\den{O}\subst{\many{x}}{\many{\den{W}}} ~(\lambda s'. T\den{B} ~s' ~\den{V}) ~\den{V'} & (match)
    \\
    =&\quad
    (E\den{O\subst{\many{x}}{\many{W}}} ~ (\lambda s'. T\den{B} ~ s' ~ \den{V})) ~ \den{V'}
    &(\cref{thm:substitution-translation})
    \\
    =&\quad
    \denbig{
      \left(
        \begin{aligned}
          &\Template{} \\
          &\quad O\subst{\many{x}}{\many{W}}; \\
          &\quad \Continue s' \to (\Template B) ~ s' ~ V
        \end{aligned}
      \right)
      ~ V'
    }
    &(\beta, \cref{thm:value-translation})
  \end{align*}
  \qed
  \end{itemize}
\end{proof}

\begin{lemma}[Template Do Match]
  \label{thm:template-do-match}

  $\den{(\Template{} (\lambda P. \Do M); B) ~ V' ~ V} = \den{M\subst{\many{x}}{\many{W}}}
  \quad (\text{if } P\subst{\many{x}}{\many{W}} = V)$.
\end{lemma}
\begin{proof}
  In terms of the source-level axioms above, we have
  \begin{align*}
    &\quad
    (\Template{} (\lambda P. \Do M); B) ~ V' ~ V
    \\
    =&\quad
    \left(
      \begin{aligned}
        &\Template \\
        &\quad \Do M\subst{\many{x}}{\many{W}}; \\
        &\quad \Continue s' \to (\Template B) ~ s' ~ V
      \end{aligned}
    \right)
    ~ V'
    &(\cref{thm:template-match})
    \\
    =&\quad
    \begin{aligned}[t]
      &(\Extension \Do M\subst{\many{x}}{\many{W}}) \\
      &\quad (\Template \Continue s' \to (\Template B) ~ s' ~ V) \\
      &\quad V'
    \end{aligned}
    &(\cref{thm:templ-ext})
    \\
    =&\quad
    \begin{aligned}[t]
      &(\Extension \Try \_ \to \Else M\subst{\many{x}}{\many{W}}) \\
      &\quad (\Template \Continue s' \to (\Template B) ~ s' ~ V) \\
      &\quad V'
    \end{aligned}
    \\
    =&\quad
    (\Template \Else M\subst{\many{x}}{\many{W}})
    ~ V'
    &(\cref{thm:ext-try})
    \\
    =&\quad
    (\Template \Continue \_ \to  M\subst{\many{x}}{\many{W}})
    ~ V'
    \\
    =&\quad
    M\subst{\many{x}}{\many{W}}    
    &(\cref{thm:templ-continue})
  \end{align*}
  and so the translation of the two sides are equal by congruence and transitivity of the equational theory (\cref{thm:conservative-extension}).
  \qed
  % By cases on whether $P$ is a variable or not:
  % \begin{itemize}
  % \item If $P = y$, then $P\subst{\many{x}}{\many{W}} = y\subst{y}{V}$ with $\many{x} = y$ and $\many{W}=V$ and:
  % \begin{align*}
  %   &\quad \den{(\Template{} (\lambda P. \Do M); B) ~ V' ~ V} \\
  %   =&\quad \den{(\Template{} (\lambda y. \Do M); B) ~ V' ~ V}\\
  %   =&\quad (\lambda s. E\den{\lambda y. \Do M} ~T\den{B} ~s) ~\den{V'} ~\den{V}\\
  %   =&\quad E\den{\lambda y. \Do M} ~T\den{B} ~\den{V'} ~\den{V} & (\beta, \cref{thm:value-translation})\\
  %   =&\quad (\lambda b. \lambda s. \lambda y. E\den{\Do M} ~(\lambda s'. b ~s' ~y) ~s) ~T\den{B} ~\den{V'} ~\den{V}\\
  %   =&\quad E\den{\Do M}\subst{y}{\den{V}} ~(\lambda s'. T\den{B} ~s' ~\den{V}) ~\den{V'} & (\beta, \cref{thm:value-translation})\\
  %   =&\quad (\lambda \_. \lambda  \_. \den{M}\subst{y}{\den{V}}) ~(\lambda s'. T\den{B} ~s' ~\den{V}) ~\den{V'}\\
  %   =&\quad \den{M}\subst{y}{\den{V}} & (\beta, \cref{thm:value-translation}) \\
  %   =&\quad \den{M\subst{y}{V}} & (\cref{thm:substitution-translation}) \\
  %   =&\quad \den{M\subst{\many{x}}{\many{W}}}
  % \end{align*}
  % \item Otherwise, by \cref{thm:substitution-translation,thm:pattern-translation},
  % \begin{math}
  %   \den{V}
  %   =
  %   \den{P\subst{\many{x}}{\many{W}}}
  %   =
  %   \den{P}\subst{\many{x}}{\many{\den{W}}}
  %   =
  %   P\subst{\many{x}}{\many{\den{W}}}
  % \end{math}
  % in the following:
  % \begin{align*}
  %   &\quad \den{(\Template{} (\lambda P. \Do M); B) ~ V' ~ V}\\
  %   =&\quad (\lambda s. E\den{\lambda P. \Do M} ~T\den{B} ~s) ~\den{V'} ~\den{V}\\
  %   =&\quad E\den{\lambda P. \Do M} ~T\den{B} ~\den{V'} ~\den{V} & (\beta,\cref{thm:value-translation})\\
  %   =&\quad E\den{\lambda y. \Match P \gets y ~\Do M} ~T\den{B} ~\den{V'} ~\den{V} \\
  %   % =&\quad (\lambda b. \lambda s. \lambda y. E\den{\Match P \gets y ~\Do M} ~(\lambda s'. b ~s' ~x) ~s) ~T\den{B} ~\den{V'} ~\den{V} \\
  %   =&\quad E\den{\Match P \gets y ~\Do M}\subst{y}{\den{V}} ~(\lambda s'. T\den{B} ~s' ~\den{V}) ~\den{V'} & (\beta, \cref{thm:value-translation}) \\
  %   =&\quad
  %   \begin{aligned}[t]
  %     &\Match \den{V} \With{} \{ \\
  %     &\quad P \to \den{\Do M}~(\lambda s'. T\den{B} ~s' ~\den{V})~\den{V'}; \\
  %     &\quad\_ \to (\lambda s'. T\den{B} ~s' ~\den{V}) ~ \den{V'}
  %     ~\}
  %   \end{aligned}
  %   &(\beta, \cref{thm:value-translation}) \\
  %   =&\quad E\den{\Do M}\subst{\many{x}}{\many{\den{W}}} ~(\lambda s'. T\den{B} ~s' ~\den{V}) ~\den{V'} & (match) \\
  %   =&\quad (\lambda \_. \lambda  \_. \den{M}\subst{\many{x}}{\many{\den{W}}}) ~(\lambda s'. T\den{B} ~s' ~\den{V}) ~\den{V'} & \\
  %   =&\quad \den{M}\subst{\many{x}}{\many{\den{W}}} & (\beta, \cref{thm:value-translation}) \\
  %   =&\quad \den{M\subst{\many{x}}{\many{W}}} & (\cref{thm:substitution-translation}) \\
  % \end{align*}
  % \qed
  % \end{itemize}
\end{proof}

\begin{lemma}[Template Apart]
  \label{thm:template-apart}

  $\den{(\Template{} (\lambda P. O); B) ~ V' ~ V} = \den{(\Template B) ~ V' ~ V}
  \qquad (\text{if } P \apart V)$.
\end{lemma}
\begin{proof}
  Since a variable can never be apart from a value, $P$ must be a non-variable pattern.
  By \cref{thm:apartness-translation}, $P \apart \den{V}$, and the translations are then equal as follows:
  \begin{align*}
    & \quad \den{(\Template{} (\lambda P. O); B) ~ V' ~ V} \\
    =& \quad E\den{\lambda P. O} ~T\den{B} ~\den{V'} ~\den{V} & (\beta,\cref{thm:value-translation}) \\
    =&\quad E\den{\lambda y. \Match P \gets y ~\Do M} ~T\den{B} ~\den{V'} ~\den{V} \\
    =&\quad E\den{\Match P \gets y ~\Do M}\subst{y}{\den{V}} ~(\lambda s'. T\den{B} ~s' ~\den{V}) ~\den{V'} & (\beta, \cref{thm:value-translation}) \\
    =& \quad
    \begin{aligned}[t]
      &\Match \den{V} \With{} \{ \\
      &\quad P \to \den{O}~(\lambda s'. T\den{B} ~s' ~\den{V})~\den{V'}; \\
      &\quad \_ \to (\lambda s'. T\den{B} ~s' ~\den{V})~\den{V'}
      ~\}
    \end{aligned}
    & (\beta, \cref{thm:value-translation}) \\
    =& \quad (\lambda s'. T\den{B} ~s' ~\den{V}) ~\den{V'} & (apart)\\
    =& \quad T\den{B} ~ \den{V'} ~ \den{V} & (\beta) \\
    =& \quad \den{(\Template B)} ~ \den{V'} ~ \den{V} \\
    =& \quad \den{(\Template B) ~ V' V}
  \end{align*}
  \qed
\end{proof}

\begin{lemma}[Template Self]
  \label{thm:template-self}
  
  $\den{(\Template{} (y ~ O); B) ~ V = (\Template O\subst{y}{V}; B) ~ V}$
\end{lemma}
\begin{proof}
  \begin{align*}
    &\quad
    \den{C[(\Template{} (y ~ O); B) ~ V]}
    \\
    =&\quad
    E\den{y ~ O} ~ T\den{B} ~ \den{V}
    &(\beta, \cref{thm:value-translation})
    \\
    =&\quad
    (\lambda b. \lambda y. E\den{O} ~ b ~ y) ~ T\den{B} ~ \den{V}
    \\
    =&\quad
    E\den{O}\subst{y}{\den{V}} ~ T\den{B} ~ \den{V}
    &(\beta, \cref{thm:value-translation})
    \\
    =&\quad
    E\den{O\subst{y}{V}} ~ T\den{B} ~ \den{V}
    &(\cref{thm:substitution-translation})
    \\
    =&\quad
    \den{(\Template O\subst{y}{V}; B) ~ V}
    &(\beta, \cref{thm:value-translation})
  \end{align*}
  \qed
\end{proof}

\begin{lemma}[Context Match]
  \label{thm:context-match}
  \begin{align*}
    \den{C[(\Template{} (Q[y] ~ O); B) ~ V]}
    &=
    \denbig{
      \begin{aligned}
        &\Template \\
        &\quad O\subst{y}{V}\subst{\many{x}}{\many{W}}; \\
        &\quad \Continue s' \to C[(\Template B) ~ s']
      \end{aligned}
    }
    \\
    &(\text{if } Q\subst{\many{x}}{\many{W}} = C \neq \hole)
    .
  \end{align*}
\end{lemma}
\begin{proof}
  By induction on the syntax of $Q$.
  \begin{itemize}
  \item $Q = \hole$ is impossible due to the assumption $Q\subst{\many{x}}{\many{W}} = C \neq \hole$.
  \item If $Q = \hole ~ P$ then $C = \hole ~ V'$ such that $P\subst{\many{x}}{\many{W}} = V$, and the equality holds by \cref{thm:template-self,thm:template-match} and congruence of the equational theory (\cref{thm:conservative-extension}):
    \begin{align*}
      &\quad
      \den{C[(\Template{} (Q[y] ~ O); B) ~ V]}
      \\
      =&\quad
      \den{(\Template{} ((y ~ P) ~ O); B) ~ V ~ V'}
      \\
      =&\quad
      \den{(\Template{} (y ~ (\lambda P. O)); B) ~ V ~ V'}
      \\
      =&\quad
      \den{(\Template{} (\lambda P. O\subst{y}{V}); B) ~ V ~ V'}
      &(\cref{thm:template-self})
      \\
      =&\quad
      \denbig{
        \left(
          \begin{aligned}
            &\Template \\
            &\quad O\subst{y}{V}\subst{\many{x}}{\many{W}}; \\
            &\quad \Continue s' \to (\Template B) ~ s' ~ V'
          \end{aligned}
        \right)
        ~ V
      }
      &(\cref{thm:template-match})
    \end{align*}
  \item If $Q = Q' ~ P$ then $C = C' ~ V'$ where $\subst{\many{x}}{\many{W}} = \subst{\many{x_1},\many{x_2}}{\many{W_1},\many{W_2}}$ such that $Q'\subst{\many{x_1}}{\many{W_2}} = C$ and $P\subst{\many{x_2}}{\many{W_2}} = V'$.
    Assume the inductive hypothesis
    \begin{align*}
      \den{C'[(\Template{} (Q'[y] ~ O); B) ~ V]}
      &=
      \denbig{
        \begin{aligned}
          &\Template \\
          &\quad O\subst{y}{V}\subst{\many{x}}{\many{W}}; \\
          &\quad \Continue s' \to C'[(\Template B) ~ s']
        \end{aligned}
      }
    \end{align*}
    The equality then holds by this inductive hypothesis, \cref{thm:template-match,thm:templ-continue}, and congruence of the equational theory (\cref{thm:conservative-extension}):
    \begin{align*}
      &\quad
      \den{C[(\Template{} (Q[y] ~ O); B) ~ V]}
      \\
      =&\quad
      \den{C'[(\Template{} ((Q'[y] ~ P) ~ O); B) ~ V] ~ V'}
      \\
      =&\quad
      \den{C'[(\Template{} (Q'[y] ~ (\lambda P. O)); B) ~ V] ~ V'}
      \\
      =&\quad
      \denbig{
        \left(
          \begin{aligned}
            &\Template \\
            &\quad \lambda P. O\subst{y}{V}\subst{\many{x_1}}{\many{W_1}}; \\
            &\quad \Continue s' \to C'[(\Template B) ~ s']
          \end{aligned}
        \right)
        ~ V ~ V'
      }
      &(IH)
      \\
      =&\quad
      \denbig{
        \left(
          \begin{aligned}
            &\Template \\
            &\quad O\subst{y}{V}\subst{\many{x_1}}{\many{W_1}}\subst{\many{x_2}}{\many{W_2}}; \\
            &\quad \Continue s'' \to \\
            &\qquad
            \left(
              \begin{aligned}
                &\Template \\
                &\quad \Continue s' \to \\
                &\qquad C'[(\Template B) ~ s']
              \end{aligned}
            \right)
            ~ s'' ~ V'
          \end{aligned}
        \right)
        ~ V
      }
      &(\cref{thm:template-match})
      \\
      =&\quad
      \denbig{
        \left(
          \begin{aligned}
            &\Template \\
            &\quad O\subst{y}{V}\subst{\many{x_1}}{\many{W_1}}\subst{\many{x_2}}{\many{W_2}}; \\
            &\quad \Continue s'' \to 
            \left(
              C'[(\Template B) ~ s'']
            \right)
            ~ V'
          \end{aligned}
        \right)
        ~ V
      }
      &(\cref{thm:templ-continue})
      \\
      =&\quad
      \denbig{
        \left(
          \begin{aligned}
            &\Template \\
            &\quad O\subst{y}{V}\subst{\many{x}}{\many{W}}; \\
            &\quad \Continue s' \to 
            C[(\Template B) ~ s']
          \end{aligned}
        \right)
        ~ V
      }
    \end{align*}
  \end{itemize}
\end{proof}
  
\begin{lemma}[Context Exact Match]
  \label{thm:context-exact-match}
  \begin{align*}
    \den{C[(\Template{} (Q[y] = M); B) ~ V]}
    &=
    \den{M\subst{y}{V}\subst{\many{x}}{\many{W}}}
    \\
    &(\text{if } Q\subst{\many{x}}{\many{W}} = C)
    .
  \end{align*}
\end{lemma}
\begin{proof}
  In terms of the source-level axioms above, we have:
  \begin{align*}
    &\quad
    C[(\Template{} (Q[y] = M); B) ~ V]
    \\
    =&\quad
    C[(\Template{} (Q[y] \Do M); B) ~ V]
    \\
    =&\quad
    \left(
      \begin{aligned}
        &\Template \\
        &\quad \Do M\subst{y}{V}\subst{\many{x}}{\many{W}}; \\
        &\quad \Continue s' \to C[(\Template B) ~ s']
      \end{aligned}
    \right)
    ~ V
    &(\cref{thm:context-match})
    \\
    =&\quad
    \begin{aligned}[t]
      &(\Extension \Do M\subst{y}{V}\subst{\many{x}}{\many{W}}) \\
      &\quad (\Template \Continue s' \to C[(\Template B) ~ s']) \\
      &\quad ~ V
    \end{aligned}
    &(\cref{thm:templ-ext})
    \\
    =&\quad
    \begin{aligned}[t]
      &(\Extension \Try \_ \to \Else M\subst{y}{V}\subst{\many{x}}{\many{W}}) \\
      &\quad (\Template \Continue s' \to C[(\Template B) ~ s']) \\
      &\quad ~ V
    \end{aligned}
    \\
    =&\quad
    (\Template \Else M\subst{y}{V}\subst{\many{x}}{\many{W}}) ~ V
    &(\cref{thm:ext-try})
    \\
    =&\quad
    (\Template \Continue \_ \to  M\subst{y}{V}\subst{\many{x}}{\many{W}}) ~ V
    \\
    =&\quad
    M\subst{y}{V}\subst{\many{x}}{\many{W}}
  \end{align*}
  and so the translation of the two sides are equal by congruence and transitivity of the equational theory (\cref{thm:conservative-extension}).
  \qed
  
  % First, note that every copattern has the form $Q = \hole ~ P_1 \dots P_n$, where each pattern $P_i$ binds a distinct set of variables $\many{x_i}$, and so the assumed matching equality $Q\subst{\many{x}}{\many{W}} = C$ implies
  % \begin{itemize}
  % \item $C = ~ V_1 \dots V_n$, where there are equal numbers of $V_i$ and $P_i$, and
  % \item for each $1 \leq i \leq n$, there are variables $\many{x_i}$ and values $\many{W_i}$ such that $P_i\subst{\many{x_i}}{\many{W_i}}$.
  % \end{itemize}

  % The equation then holds by induction on the copattern $Q = \hole ~ P_i \dots P_n$ and matching pairs $P_i\subst{\many{x_i}}{\many{W_i}} = V_i$as follows:
  % \begin{align*}
  %   &\quad
  %   \den{C[(\Template{} (Q[y] = M); B) ~ V]}
  %   \\
  %   =&\quad
  %   \den{(\Template{} (y ~ P_1 \dots P_n = M); B) ~ V ~ V_1 \dots V_n}
  %   \\
  %   =&\quad
  %   \den{(\Template{} (y ~ \lambda P_1. \dots \lambda P_n. \Do M); B) ~ V ~ V_1 \dots V_n}
  %   \\
  %   =&\quad
  %   \den{(\Template{} (\lambda P_1. \dots \lambda P_n. \Do M\subst{y}{V}); B) ~ V ~ V_1 \dots V_n}
  %   &(\cref{thm:template-self})
  %   \\
  %   =&\quad
  %   \denbig{
  %     \left(
  %       \begin{aligned}
  %         &\Template \\
  %         &\quad \Do M\subst{y}{V}\subst{\many{x}}{\many{W}}; \\
  %         &\quad \Continue s' \to (\Template B) ~ s' ~ V_1 \dots V_n
  %       \end{aligned}
  %     \right)
  %     ~ V
  %   }
  %   &(\cref{thm:template-match})
  %   \\
  %   =&\quad
  %   \denbig{
  %     \begin{aligned}
  %       &(\Extension \Do M\subst{y}{V}\subst{\many{x}}{\many{W}})\\
  %       &\quad (\Template \Continue s' \to (\Template B) ~ s' ~ V_1 \dots V_n) \\
  %       &\quad V
  %     \end{aligned}
  %   }
  %   &(\cref{thm:templ-ext})
  %   \\
  %   =&\quad
  %   \denbig{
  %     \begin{aligned}
  %       &(\Extension \Try \_ \to \Continue \_ \to M\subst{y}{V}\subst{\many{x}}{\many{W}})\\
  %       &\quad (\Template \Continue s' \to (\Template B) ~ s' ~ V_1 \dots V_n) \\
  %       &\quad V
  %     \end{aligned}
  %   }
  %   \\
  %   =&\quad
  %   \den{
  %     (\Template \Continue \_ \to M\subst{y}{V}\subst{\many{x}}{\many{W}}) ~ V
  %   }
  %   &(\cref{thm:ext-try})
  %   \\
  %   =&\quad
  %   \den{
  %     M\subst{y}{V}\subst{\many{x}}{\many{W}}
  %   }
  %   &(\cref{thm:templ-continue})
  % \end{align*}
\end{proof}

\begin{lemma}[Context Apart]
  \label{thm:context-apart}

  $\den{C[(\Template{} (Q[y] ~ O); B) ~ V]} = \den{C[(\Template B) ~ V]}
  \qquad (\text{if } Q \apart C)$
\end{lemma}
\begin{proof}
  % Note that derivation of apartness can be rewritten such that the base case, proving $\hole ~ P_1 \dots P_n \apart \hole ~ V_1 \dots V_n$ from $P_n \apart V_n$, is such that $P_n \apart V_n$ is the \emph{first} non-matching application, and each previous application (for $1 \leq i < n$) matches as some $P_i\subst{\many{x_i}}{\many{W_i}} = V_i$.
  % If there is an earlier non-matching application, then that can form a new smaller base case closer to $\hole$, and all following applications are added via the other two rules for copattern apartness.
  % The proof then proceeds by induction on the derivation of apartness $Q \apart C$ with the above invariant.
  By induction on the derivation of apartness $Q \apart C$:
  \begin{itemize}
  \item Suppose $Q \apart C$ because $Q = Q' ~ P$ and $C = C' ~ W$ such that $P \apart W$ and $Q'\subst{\many{x}}{\many{W}} = C'$.
    % The two sides are equal \dots by \cref{thm:template-match,thm:template-apart}.
    \begin{align*}
      & \quad \den{C'[(\Template{} ((Q'[y] ~P) ~ O); B) ~ V] ~W} \\
      =& \quad \den{C'[(\Template{} (Q'[y] ~(\lambda P. ~O)); B) ~ V] ~W} \\
      =& \quad \den{C'} ~\denbig{
        \left(
          \begin{aligned}
            &\Template{} \\
            &\quad (\lambda P. ~O)\subst{\many{x}}{\many{W}}; \\
            &\quad \Continue s' \to (\Template B) ~ s' ~ W
          \end{aligned}
        \right)
        ~ V
      } & (\cref{thm:compositional-translation,thm:template-match})\\
      =& \quad \den{C'} \den{\Continue s' \to (\Template B) ~ s' ~ W} ~\den{V} & (\cref{thm:template-apart}) \\
      =& \quad \den{C'} (\lambda s'. \den{(\Template B)} ~ s' ~\den{W}) ~\den{V} \\
      =& \quad \den{C'} \den{(\Template B) ~V ~W} & (\beta)\\
      =& \quad \den{C'[(\Template B) ~ V ~ W]} & (\cref{thm:compositional-translation}) \\
      =& \quad \den{C[(\Template B) ~ V]}
    \end{align*}

  \item Suppose $Q \apart C$ because $Q = Q' ~ P$ and $Q' \apart C$, and assume the inductive hypothesis
    \begin{math}
      \den{C[(\Template{} (Q'[y] ~ O); B) ~ V]} = \den{C[(\Template B) ~ V]}
      .
    \end{math}
    % The two sides are equal \dots by the inductive hypothesis.
    \begin{align*}
      & \quad \den{C[(\Template{} ((Q'[y] ~P) ~ O); B) ~ V]} \\
      =& \quad \den{C[(\Template{} (Q'[y] ~ (\lambda P. ~O)); B) ~ V]} \\
      =& \quad \den{C[(\Template{} (Q'[y] ~ (\lambda P. ~O)); B) ~ V]} & (IH)
    \end{align*}
  \item Suppose $Q \apart C$ because $C = C' ~ W$ and  $Q \apart C'$, and assume the inductive hypothesis
    \begin{math}
      \den{C'[(\Template{} (Q[y] ~ O); B) ~ V]} = \den{C'[(\Template B) ~ V]}
      .
    \end{math}
    % The two sides are equal \dots by the inductive hypothesis and congruence (\cref{thm:conservative-extension}).
    \begin{align*}
      & \quad \den{C[(\Template{} (Q[y] ~ O); B) ~ V]} \\
      =& \quad \den{C'[(\Template{} (Q[y] ~ (\lambda P. ~O)); B) ~ V]} ~\den{W}\\
      =& \quad \den{C'[(\Template B) ~ V]} ~\den{W} & (IH)\\
      =& \quad \den{C[(\Template B) ~ V]}
    \end{align*}
  \end{itemize}
  \qed
\end{proof}

\begin{lemma}[Context $\lamstar$ Match]
  \label{thm:context-lamstar-match}
  \begin{align*}
    \den{C[\lamstar (Q[y] = M); B]}
    &=
    \den{M\subst{y}{(\lamstar (Q[y] = M); B)}\subst{\many{x}}{\many{W}}}
    \\
    &(\text{if } Q\subst{\many{x}}{\many{W}} = C)
  \end{align*}
\end{lemma}
\begin{proof}
  In terms of the source-level axioms above, we have:
  \begin{align*}
    &\quad
    C[\lamstar (Q[y] = M); B]
    \\
    =&\quad
    C[(\Template{} (Q[y] = M); B)~(\lamstar (Q[y]=M); B)]
    &(\cref{thm:unfold-lamstar})
    \\
    =&\quad
    C[M\subst{y}{(\lamstar (Q[y]=M); B)}\subst{\many{x}}{\many{W}}]
    &(Q\subst{\many{x}}{\many{W}} = C, \cref{thm:context-exact-match})
  \end{align*}
  and so the translation of the two sides are equal by congruence and transitivity of the equational theory (\cref{thm:conservative-extension}).
  \qed
\end{proof}

\begin{lemma}[Context $\lamstar$ Apart]
  \label{thm:context-lamstar-apart}

  $\den{C[\lamstar (Q[y] ~ O); \Else M]} = \den{C[M]}
  \qquad (\text{if } Q \apart C)$.
\end{lemma}
\begin{proof}
  In terms of the source-level axioms above, we have:
  \begin{align*}
    &\quad
    C[\lamstar (Q[y] ~ O); \Else M]
    \\
    =&\quad
    C[(\Template{} (Q[y] ~ O); \Else M) ~ (\lamstar (Q[y] ~ O); \Else M)]
    &(\cref{thm:unfold-lamstar})
    \\
    =&\quad
    C[(\Template \Else M) ~ (\lamstar (Q[y] ~ O); \Else M)]
    &(Q \apart C, \cref{thm:context-apart})
    \\
    =&\quad
    C[(\Template \Continue \_ \to M) ~ (\lamstar (Q[y] ~ O); \Else M)]
    \\
    =&\quad
    C[M]
    &(\cref{thm:templ-continue})
  \end{align*}
  and so the translation of the two sides are equal by congruence and transitivity of the equational theory (\cref{thm:conservative-extension}).
  \qed
\end{proof}

%%% Local Variables:
%%% mode: LaTeX
%%% TeX-master: "coscheme"
%%% End:
