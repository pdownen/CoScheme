\allowdisplaybreaks

\adriano{Review the copattern case (probably use induction)}

\adriano{Figure out the correct argument to assure things about $\den{M}$'s}


\thmvaluetranslation*
\begin{proof}
  % The listed instances of translation are all values up to the equational theory of the target language in \cref{fig:target-equality}:

  % The proof follows
  By mutual induction on the syntax of templates $B$, extensions $O$, extension functions $F$, and values $V$.
  % By definition, we know that our translation returns terms in the target language.
  % In other words, we can say that $\den{M}=M'$ for some target term $M'$.
  \begin{enumerate}[(a)]
  \item $T\den{B} = \lambda s. M$ for some term $M$, as shown by the following cases:
    % \begin{proof}
    %   By induction on $B$.
    \begin{itemize}
    \item $(B = \varepsilon)$
      % By our translation we have:
      $T\den{\varepsilon} = \lambda s. ~\mathit{fail} ~s$, so $M=\mathit{fail} ~s$.
    \item ($B = O; B'$)
      $T\den{O; B'} = \lambda s. ~\den{O} ~\den{B'} ~s$, so $M = \den{O} ~\den{B'} ~s$.
      % By our translation we have: $T\den{O; B'} = \lambda s. ~\den{O} ~\den{B'} ~s$.
      % Our induction hypothesis provides us that $T\den{B'} = \lambda s. M'$ for some term $M'$.
      % % By (b) we know that $E\den{O}=\lambda b. \lambda s. M_O$ for some term $M_O$.
      % \begin{align*}
      %   & \quad \lambda s. ~\den{O} ~\den{B'} ~s \\
      %   % =& \quad \lambda s.  ~(\lambda b. \lambda s. M_O) ~(\lambda s. M') ~s & (IH, (b))
      %   =& \quad \lambda s. ~M_O ~(\lambda s. M') ~s & (IH)
      % \end{align*}
      % Where $M=M_O ~(\lambda s. M') ~s$.
    \item $(B = \Continue x {\,\to\,} N)$
      $T\den{\Continue x {\,\to\,} N} = \lambda x. \den{N}$, so $M = \den{N}$.
      % \begin{align*}
      %   & \quad T\den{\Continue x \to M'} = \lambda x. ~\den{M'} \\
      %   =& \quad \lambda x. ~(\lambda s. ~M'') \\
      %   =& \quad \lambda s. ~(\lambda s. ~M'') \subst{x}{s} & (=_{\alpha})
      % \end{align*} 
    \end{itemize}
    % \qed
    % \end{proof}
  \item $E\den{O} = \lambda b. \lambda s. M$ for some term $M$, as shown by the following cases: 
    % \begin{proof}
    %   By induction on $O$.
    \begin{itemize}
    \item $(O = \varepsilon)$
      % By our translation we have
      $E\den{\varepsilon} = \lambda b. \lambda s. ~b ~s$, so $M= b ~s$.
    \item $(O = O_1;O_2)$
      $E\den{O_1;O_2} = \lambda b. \lambda s. ~\den{O_1} ~(\den{O_2} ~b) ~s$, so $M = \den{O_1} ~(\den{O_2} ~b) ~s$.
      % \begin{align*}
      %   & \quad E\den{O_1;O_2} = \lambda b. \lambda s. ~\den{O_1} ~(\den{O_2} ~b) ~s\\
      %   =& \quad \lambda b. \lambda s. ~(\lambda b. \lambda s. ~M_{O_1}) ~((\lambda b. \lambda s. ~M_{O_2}) ~b) ~s & (IH)
      % \end{align*}
      % Where $M=(\lambda b. \lambda s. ~M_{O_1}) ~((\lambda b. \lambda s. ~M_{O_2}) ~b) ~s$.
    \item $(O = Q[x] ~O)$ follows by induction on $Q$ (generalizing $O$):
      \begin{itemize}
      \item $(Q=\hole)$ for all $O$,
        % According to our translation:
        \begin{align*}
          E\den{x ~O}
          &=
          \lambda b. \lambda x. E\den{O} ~ b ~ x
          \\
          &=
          \lambda b. \lambda s. E\den{O}\subst{x}{s} ~ b ~ s
          &(\alpha)
        \end{align*}
        so $M = E\den{O}\subst{x}{s} ~ b ~ s$ for the given $O$.
        % By our induction hypothesis we can infer that $E\den{O}=\lambda b. \lambda s. M_O$.
        % Therefore, we can conclude that $\lambda b. \lambda x. ~(\lambda b. \lambda s. M_O) ~ b ~ x$, where $ M = (\lambda b. \lambda s. M_O) ~ b ~ x$.
      \item $(Q=Q'~P)$
        assuming the inductive hypothesis (IH) that, for all $O$, there is an $N_O$ such that $E\den{Q[x] ~ O} = \lambda b. \lambda s. N_O$.
        For all $O$,
        \begin{align*}
          E\den{(Q'[x] ~ P) O}
          &=
          E\den{Q'[x] ~ (\lambda P. O)}
          \\
          &=
          \lambda b. \lambda s. N_{(\lambda P. O)}
          &(IH)
        \end{align*}
        so $M = N_{(\lambda P. O)}$ given by the inductive hypothesis applied to $\lambda P. O$.
        % According to our translation:
        % $E\den{(Q ~P) ~ [x] ~O} = E\den{(Q[x] ~P) ~O} = E\den{Q[x] ~ (\lambda P. O)}$.
        % Eventually, we will hit the previous case after converting all patterns in the copattern into pattern $\lambda$'s.
        % After converting all patterns $O$ will have a shape of form: $\lambda P_0. ~\lambda P_1 ... \lambda P_n. ~O$.
        % \adriano{I think I need to use induction here.}
      \end{itemize}
    \item $(O = \lambda P. ~O)$ follows by cases if $P$ is a variable or another pattern:
      \begin{itemize}
      \item $(P \in \mathit{Variable})$
        \begin{math}
          E\den{\lambda x. ~O}
          =
          \lambda b. \lambda s.
          (\lambda x. E\den{O} ~ (\lambda s'. b ~ s' ~ x) ~ s)
          ,
        \end{math}
        so
        \\
        $M = \lambda x. E\den{O} ~ (\lambda s'. b ~ s' ~ x) ~ s$.
      \item $(P \notin \mathit{Variable})$
      \begin{math}
        E\den{\lambda P. ~O}
        =
        E\den{\lambda x. \Match P \gets x ~ O}
        ,
      \end{math}
      which follows by the above case.
      \end{itemize}
      % According to our translation:
      % \begin{align*} 
      %   & \quad E\den{\lambda P. ~O} = E\den{\lambda x. \Match P \gets x ~ O}\\
      %   =& \quad \lambda b. \lambda s. (\lambda x. E\den{\Match P \gets x ~ O} ~ (\lambda s'. b ~ s' ~ x) ~ s) \\
      %   =& \quad \lambda b. \lambda s. (\lambda x. \lambda b. \lambda s. (
      %   \begin{aligned}[t]
      %     &\Match \den{M} \With \\
      %     &\quad
      %     \begin{aligned}[t]
      %       \{~
      %       P &\to E\den{O}~b~s; \\
      %       \_ &\to b~s
      %       ~\}
      %     \end{aligned}
      %   \end{aligned}
      %   )~ (\lambda s'. b ~ s' ~ x) ~ s) \\
      %   =& \quad \lambda b. \lambda s. (\lambda x. \lambda b. \lambda s. (
      %   \begin{aligned}[t]
      %     &\Match \den{M} \With \\
      %     &\quad
      %     \begin{aligned}[t]
      %       \{~
      %       P &\to (\lambda b. \lambda s. M_O)~b~s; \\
      %       \_ &\to b~s
      %       ~\}
      %     \end{aligned}
      %   \end{aligned}
      %   )~ (\lambda s'. b ~ s' ~ x) ~ s) & (IH)
      % \end{align*}
    \item $(O = \Match P \gets N ~ O)$
        \begin{align*}
          & \quad E\den{\Match P \gets N ~ O}
          =
          \lambda b. \lambda s.
          \begin{aligned}[t]
            &\Match \den{N} \With \\
            &\quad
            \begin{aligned}[t]
              \{~
              P &\to E\den{O}~b~s; \\
              \_ &\to b~s
              ~\}
            \end{aligned}
          \end{aligned}
          % \\
          % =& \quad \lambda b. \lambda s.
          % \begin{aligned}[t]
          %   &\Match \den{N} \With \\
          %   &\quad
          %   \begin{aligned}[t]
          %     \{~
          %     P &\to (\lambda b. \lambda s.~ M_O) ~b~s; \\
          %     \_ &\to b~s
          %     ~\}
          %   \end{aligned}
          % \end{aligned}  & (IH)
        \end{align*}
        so $M = \Match \den{N} \With \set{P \to E\den{O}~b~s; \_ \to b~s}$.
      \item $(O = \Nest O)$
        \begin{math}
          E\den{\Nest O}
          =
          \lambda b. \lambda s.
          (\Rec s' = E\den{O} ~ (\lambda \_. b ~ s) ~ (\lambda x. s' ~ x))
          ,
        \end{math}
        so $M = (\Rec s' = E\den{O} ~ (\lambda \_. b ~ s) ~ (\lambda x. s' ~ x))$
        % \begin{align*}
        %   & \quad E\den{\Nest O} = \lambda b. \lambda s. \Rec s' = E\den{O} ~ (\lambda \_. b ~ s) ~ (\lambda x. s' ~ x)\\
        %   =& \quad \lambda b. \lambda s. \Rec s' = (\lambda b. \lambda s.~ M_O) ~ (\lambda \_. b ~ s) ~ (\lambda x. s' ~ x) & (IH)
        % \end{align*}
      \item $(O = \Try x \to B)$
        assuming the inductive hypothesis $(IH)$ from part (a) that
        $T\den{B} = \lambda s. N$ for some $N$,
        \begin{align*}
          E\den{\Try x \to B}
          &= \lambda x. T\den{B}
          \\
          &= \lambda x. (\lambda s.~ N)
          & (IH)
          \\
          &=\lambda b. (\lambda s.~ N)\subst{x}{b}
          & (\alpha)
        \end{align*}
        so $M = N\subst{x}{b}$
    \end{itemize}
    % \qed
    % \end{proof}
  \item $E\den{F} = \lambda b. \lambda s. \lambda x. M$ for some term $M$, as shown by the following cases:
    % \begin{proof}
    %   Let us consider the possible values of $F$.
    \begin{itemize}
    \item $(F= \lambda P. ~O)$
      Following the same calculation in the matching special case of part (b) above,
      $E\den{\lambda P. O} = \lambda b. \lambda s. (\lambda x. M)$
      for some $M$.
    %   Let' consider if $P$ is a variable pattern or not:
    %   \begin{itemize}
    %   \item $(P = x)$ According to our translation $E\den{\lambda x. ~O}=\lambda b. \lambda s. (\lambda x. E\den{O} ~ (\lambda s'. b ~ s' ~ x) ~ s)$.
    %     Therefore, by (b), we can conclude that $\lambda b. \lambda s. (\lambda x. (\lambda b. \lambda s. M_O) ~ (\lambda s'. b ~ s' ~ x) ~ s)$
    %   \item $(P \neq x)$ We have that $E\den{\lambda P. ~O}=E\den{\lambda x. \Match P \gets x ~ O}$ which is a specific case of the previous case, where $O=\Match P \gets x ~ O$.
    %   \end{itemize} 
    \item $(F= Q[x ~P] ~O)$
      follows by induction on $Q$ (generalizing $O$):
      \begin{itemize}
      \item $(Q = \hole)$ for all $O$,
        \begin{align*}
          E\den{(y ~ P) ~ O}
          =
          E\den{y ~ (\lambda P. O)}
          &=
          \lambda b. \lambda y. E\den{\lambda P. O} ~ b ~ y
          % \\
          % &=
          % \lambda b. \lambda s. E\den{\lambda P. O}\subst{y}{s} ~ b ~ s
          % &(\alpha)
        \end{align*}
        Following the same calculation in the previous case $(F = \lambda P. O)$ gives us
        some $N$ such that $E\den{\lambda P. O} = \lambda b. \lambda s'. \lambda x. N$, so continuing we have
        \begin{align*}
          E\den{(y ~ P) ~ O}
          &=
          \lambda b. \lambda y. (\lambda b. \lambda s'. \lambda x. N) ~ b ~ y
          \\
          &=
          \lambda b. \lambda y. \lambda x. N\subst{s'}{y}
          &(\beta)
          \\
          &=
          \lambda b. \lambda s. \lambda x. N\subst{s'}{y}\subst{y}{s}
          &(\alpha)
        \end{align*}
        so $M = N\subst{s'}{y}\subst{y}{s}$.
      \item $(Q = Q' ~ P')$
        assuming the inductive hypothesis that,
        for all $O$, there is an $N_O$ such that
        $E\den{Q'[y ~ P] ~ O} = \lambda b. \lambda s. \lambda x. N_O$.
        For all $O$,
        \begin{align*}
          E\den{(Q'[y ~ P] ~ P') ~ O}
          &=
          E\den{Q'[y ~ P] ~ (\lambda P'. O)}
          \\
          &=
          \lambda b. \lambda s. \lambda x. N_{(\lambda P'. O)}
          &(IH)
        \end{align*}
        so $M = N_{(\lambda P'. O)}$ given by the inductive hypothesis applied to $\lambda P'. O$.
      \end{itemize}
      % Eventually, after converting the whole copattern we will hit $E\den{x ~O}$, where $O$ is some sequence of nested $\lambda P$'s.
      % \begin{align*}
      %   & \quad E\den{x ~O} =  \lambda b. \lambda x. E\den{\lambda P. O'} ~ b ~ x\\
      %   =& \quad \lambda b. \lambda x. (\lambda b. \lambda s. \lambda x. M') ~ b ~ x & (IH) \\
      %   =& \quad \lambda b. \lambda x. (\lambda x. M'\subst{s}{x}) & (\beta) \\
      %   =& \quad \lambda b. \lambda s. (\lambda x. M'\subst{s}{x})\subst{x}{s} & (\alpha)
      % \end{align*}
    \end{itemize}
    % \qed
    % \end{proof}
  \item $\den{V} = W$ for some value $W$, as shown by the following cases:
    % \begin{proof}
    %   By induction on $V$.
    \begin{itemize}
    \item $(V = x)$
      $\den{x} = x$, so $W=x$.
    \item $(V = \lambda x. M)$
      $\den{\lambda x. M} = \lambda x. \den{M}$, so $W = \lambda x. \den{M}$.
    \item $(V = \Null)$
      $\den{\Null} = \Null$, so $W=\Null$.
    \item $(V = \Cons V_1 ~ V_2)$
      $\den{\Cons V_1 ~ V_2} = \Cons \den{V_1} ~ \den{V_2}$,
      where $\den{V_1} = W_1$ and $\den{V_2} = W_2$ by the inductive hypotheses,
      so $W = \Cons W_1 ~ W_2$.
    \item $(V = \Template B)$
      $\den{\Template B} = T\den{B} = \lambda s. M$, for some $M$,
      by the inductive hypothesis part (a),
      so $W = \lambda s. M$.
    \item $(V = \Extension O)$
      $\den{\Extension O} = E\den{O} = \lambda b. \lambda s. M$, for some $M$,
      by the inductive hypothesis part (b),
      so $W = \lambda b. \lambda s. M$.
    \item $(V = \lamstar (F; B))$
      assuming the inductive hypotheses that 
      \begin{itemize}
      \item[$IH_1$] there is some $N_1$ such that
        $E\den{F} = \lambda b. \lambda s. \lambda x. N_1$, and
      \item[$IH_2$] there is some $N_2$ such that
        $T\den{B} = \lambda s. N_2$,
      \end{itemize}
      \begin{align*}
        \den{\lamstar (F; B)}
        &=
        (\Rec \mathit{self} = T\den{F; B} ~ (\lambda x. \mathit{self} ~ x))
        \\
        &=
        (\Rec \mathit{self} = E\den{F} ~ T\den{B} ~ (\lambda x. \mathit{self} ~ x))
        &(\beta)
        \\
        &=
        (\Rec \mathit{self}
        = (\lambda b. \lambda s. \lambda x. N_1)
        ~ T\den{B}
        ~ (\lambda x. \mathit{self} ~ x))
        &(IH_1)
        \\
        &=
        (\Rec \mathit{self}
        = (\lambda b. \lambda s. \lambda x. N_1)
        ~ (\lambda s. N_2)
        ~ (\lambda x. \mathit{self} ~ x))
        &(IH_2)
        \\
        &=
        (\Rec \mathit{self}
        = \lambda x.N_1\subst{b}{(\lambda s.N_2)}\subst{s}{(\lambda x.\mathit{self}~x)})
        &(\beta)
        \\
        &=
        \begin{aligned}[t]
          \lambda x.
          N_1
          &\subst{b}{(\lambda s.N_2)}
          \\
          &\subst{s}{(\lambda x.\mathit{self}~x)}
          \\
          &\subst
          {\mathit{self}}
          {
            (\Rec \mathit{self}
            =
            \lambda x.N_1\subst{b}{(\lambda s.N_2)}\subst{s}{(\lambda x.\mathit{self}~x)})
          }
        \end{aligned}
        &(rec)
      \end{align*}
    % \qed
    % \end{proof}
    \end{itemize}
  \end{enumerate}
\end{proof}

\thmsoundness*
\begin{proof}
  Each axiom is derived up to the target equational theory in the following lemmas.
\end{proof}

\begin{lemma}[Extension Composition Identity Left]
  \label{thm:ext-compose-id-left}
    $ E\den{\varepsilon; O} = E\den{O}.$
\end{lemma}
    \begin{proof}
        \begin{align*}
            &\quad E\den{\varepsilon; O} \\
            =& \quad \lambda b. \lambda s.~ E\den{\varepsilon} ~(E\den{O} ~b) ~s \\
            =&  \quad \lambda b. \lambda s.~ E\den{\varepsilon} ~((\lambda b. \lambda s.~ M_0) ~b) ~s & (\cref{l-value})\\
            =& \quad \lambda b. \lambda s.~ (\lambda b. \lambda s.~ b ~s) ~((\lambda b. \lambda s.~ M_0) ~b) ~s \\
            =& \quad \lambda b. \lambda s.~ (\lambda b. \lambda s.~ b ~s) ~(\lambda s.~ M_0) ~s & (\beta)\\
            =& \quad \lambda b. \lambda s.~ (\lambda s.~ (\lambda s.~ M_0) ~s) ~s & (\beta)\\
            =& \quad \lambda b. \lambda s.~ (\lambda s.~ M_0) ~s & (\beta)\\
            =& \quad \lambda b. \lambda s.~ M_0 & (\beta) \\
            =& \quad E\den{O} & (\cref{l-value})
        \end{align*}
        \qed
    \end{proof}

%% Paul: Removing this lemma since it is the only one that requires eta.
    
% \begin{lemma}[Extension Composition Identity Right]
%   \label{thm:ext-compose-id-right}
%   $ E\den{O} = E\den{O;\varepsilon}.$
% \end{lemma}
%     \begin{proof}
%         \begin{align*}
%             &\quad E\den{O;\varepsilon} \\
%             =& \quad \lambda b. \lambda s.~ E\den{O} ~(E\den{\varepsilon} ~b) ~s \\
%             =& \quad \lambda b. \lambda s.~ E\den{O} ~((\lambda b. \lambda s.~ b ~s) ~b) ~s \\
%             =& \quad \lambda b. \lambda s.~ E\den{O} ~(\lambda s.~ b ~s) ~s & (\beta)\\
%             =& \quad \lambda b. \lambda s.~ (\lambda b. \lambda s.~ M_0) ~(\lambda s.~ b ~s) ~s & (\cref{l-value})\\
%             =& \quad \color{red}{\lambda b. \lambda s.~ (\lambda b. \lambda s.~ M_0) ~b ~s} & \color{red}{(\eta)}\\
%             =& \quad \color{red}{\lambda b. \lambda s.~ (\lambda s.~ M_0) ~s} & (\beta)\\
%             =& \quad \color{red}{\lambda b. \lambda s.~ M_0} & (\beta) \\
%             =& \quad \color{red}{E\den{O}} & (\cref{l-value})
%         \end{align*}
%         \qed
%     \end{proof}

\begin{lemma}[Template Composition Identity Left]
  \label{thm:tmpl-compose-id-left}
  $ T\den{\varepsilon; B} = T\den{B}.$
\end{lemma}
    \begin{proof}
        \begin{align*}
            &\quad T\den{\varepsilon; B} \\
            =& \quad \lambda s. ~ E\den{\varepsilon} ~T\den{B} ~s \\
            =& \quad \lambda s. ~ (\lambda b. \lambda s.~ b ~s) ~T\den{B} ~s \\
            =& \quad \lambda s. ~ (\lambda b. \lambda s.~ b ~s) ~(\lambda s.~ M_0) ~s & (\cref{l-value})\\
            =& \quad \lambda s. ~ (\lambda s.~ (\lambda s.~ M_0) ~s) ~s & (\beta)\\
            =& \quad \lambda s. ~ (\lambda s.~ M_0) ~s & (\beta)\\
            =& \quad \lambda s. ~ M_0 & (\beta) \\
            =& \quad T\den{B} & (\cref{l-value})
        \end{align*}
        \qed
    \end{proof}

\begin{lemma}[Extension Composition Associativity]
  \label{thm:ext-compose-assoc}
  \\
  $ E\den{(O_1;O_2);O_3} = E\den{O_1;(O_2;O_3)}.$
\end{lemma}
    \begin{proof}
        \begin{align*}
            &\quad E\den{(O_1;O_2);O_3} \\
            =& \quad \lambda b. \lambda s.~ E\den{O_1;O_2} ~(E\den{O_3} ~b) ~s \\
            =& \quad \lambda b. \lambda s.~ (\lambda b. \lambda s.~ E\den{O_1} ~(E\den{O_2} ~b) ~s) ~(E\den{O_3} ~b) ~s \\
            =& \quad \lambda b. \lambda s.~ (\lambda b. \lambda s.~ E\den{O_1} ~(E\den{O_2} ~b) ~s) ~((\lambda b. \lambda s.~ M_3) ~b) ~s & (\cref{l-value})\\
            =& \quad \lambda b. \lambda s.~ (\lambda b. \lambda s.~ E\den{O_1} ~(E\den{O_2} ~b) ~s) ~(\lambda s.~ M_3) ~s & (\beta)\\
            =& \quad \lambda b. \lambda s.~ (\lambda b. \lambda s.~ (\lambda b. \lambda s.~ M_1) ~(E\den{O_2} ~b) ~s) ~(\lambda s.~ M_3) ~s & (\cref{l-value})\\
            =& \quad \lambda b. \lambda s.~ (\lambda b. \lambda s.~ (\lambda b. \lambda s.~ M_1) ~((\lambda b. \lambda s.~ M_2) ~b) ~s) ~(\lambda s.~ M_3) ~s & (\cref{l-value})\\
            =& \quad \lambda b. \lambda s.~ (\lambda b. \lambda s.~ (\lambda b. \lambda s.~ M_1) ~(\lambda s.~ M_2) ~s) ~(\lambda s.~ M_3) ~s & (\beta) \\
            =& \quad \lambda b. \lambda s.~ (\lambda b. \lambda s.~ (\lambda s.~ M_1\subst{b}{\lambda s.~ M_2}) ~s) ~(\lambda s.~ M_3) ~s & (\beta) \\
            =& \quad \lambda b. \lambda s.~ (\lambda s.~ (\lambda s.~ M_1\subst{b}{\lambda s.~ M_2}\subst{b}{\lambda s.~ M_3}) ~s) ~s & (\beta) \\
            =& \quad \lambda b. \lambda s.~ (\lambda s.~ M_1\subst{b}{\lambda s.~ M_2}\subst{b}{\lambda s.~ M_3}) ~s & (\beta) \\
            =& \quad \lambda b. \lambda s.~ \color{red}{M_1\subst{b}{\lambda s.~ M_2}\subst{b}{\lambda s.~ M_3}} & (\beta)
        \end{align*}

        \begin{align*}
            &\quad E\den{O_1;(O_2;O_3)} \\
            =& \quad \lambda b. \lambda s.~ E\den{O_1} ~(\den{O_2;O_3} ~b) ~s \\
            =& \quad \lambda b. \lambda s.~ E\den{O_1} ~((\lambda b. \lambda s.~ E\den{O_2} ~(E\den{O_3} ~b) ~s) ~b) ~s \\
            =& \quad \lambda b. \lambda s.~ E\den{O_1} ~(\lambda s.~ E\den{O_2} ~(E\den{O_3} ~b) ~s) ~s & (\beta) \\
            =& \quad \lambda b. \lambda s.~ (\lambda b. \lambda s.~ M_1) ~(\lambda s.~ E\den{O_2} ~(E\den{O_3} ~b) ~s) ~s & (\cref{l-value})\\
            =& \quad \lambda b. \lambda s.~ (\lambda b. \lambda s.~ M_1) ~(\lambda s.~ (\lambda b. \lambda s.~ M_2) ~(E\den{O_3} ~b) ~s) ~s & (\cref{l-value})\\
            =& \quad \lambda b. \lambda s.~ (\lambda b. \lambda s.~ M_1) ~(\lambda s.~ (\lambda b. \lambda s.~ M_2) ~((\lambda b. \lambda s.~ M_3) ~b) ~s) ~s & (\cref{l-value})\\
            =& \quad \lambda b. \lambda s.~ (\lambda b. \lambda s.~ M_1) ~(\lambda s.~ (\lambda b. \lambda s.~ M_2) ~(\lambda s.~ M_3) ~s) ~s & (\beta)\\
            =& \quad \lambda b. \lambda s.~ (\lambda b. \lambda s.~ M_1) ~(\lambda s.~ (\lambda s.~ M_2\subst{b}{\lambda s.~ M_3}) ~s) ~s & (\beta)\\
            =& \quad \lambda b. \lambda s.~ (\lambda b. \lambda s.~ M_1) ~(\lambda s.~ M_2\subst{b}{\lambda s.~ M_3}) ~s & (\beta)\\
            =& \quad \lambda b. \lambda s.~ (\lambda s.~ M_1\subst{b}{\lambda s.~ M_2\subst{b}{\lambda s.~ M_3}}) ~s & (\beta)\\
            =& \quad \lambda b. \lambda s.~ \color{red}{M_1\subst{b}{\lambda s.~ M_2\subst{b}{\lambda s.~ M_3}}} & (\beta)
        \end{align*}
        \qed
    \end{proof}

\begin{lemma}[Template Composition Associativity]
  \label{thm:templ-compose-assoc}
  $ T\den{(O_1;O_2);B} = T\den{O_1;(O_2;B)}.$
\end{lemma}
    \begin{proof}
        \begin{align*}
            &\quad T\den{(O_1;O_2);B} \\
            =& \quad \lambda s.~ E\den{O_1;O_2} ~T\den{B} ~s \\
            =& \quad \lambda s.~ (\lambda b. \lambda s.~ E\den{O_1} ~(E\den{O_2} ~b) ~s) ~T\den{B} ~s \\
            =& \quad \lambda s.~ (\lambda b. \lambda s.~ (\lambda b. \lambda s.~ M_1) ~(E\den{O_2} ~b) ~s) ~T\den{B} ~s & (\cref{l-value})\\
            =& \quad \lambda s.~ (\lambda b. \lambda s.~ (\lambda b. \lambda s.~ M_1) ~((\lambda b. \lambda s.~ M_2) ~b) ~s) ~T\den{B} ~s & (\cref{l-value})\\
            =& \quad \lambda s.~ (\lambda b. \lambda s.~ (\lambda b. \lambda s.~ M_1) ~(\lambda s.~ M_2) ~s) ~T\den{B} ~s & (\beta)\\
            =& \quad \lambda s.~ (\lambda b. \lambda s.~ (\lambda s.~ M_1\subst{b}{\lambda s.~ M_2}) ~s) ~T\den{B} ~s & (\beta)\\
            =& \quad \lambda s.~ (\lambda b. \lambda s.~ M_1\subst{b}{\lambda s.~ M_2}) ~T\den{B} ~s & (\beta)\\
            =& \quad \lambda s.~ (\lambda b. \lambda s.~ M_1\subst{b}{\lambda s.~ M_2}) ~(\lambda s.~ M_B) ~s & (\cref{l-value})\\
            =& \quad \lambda s.~ (\lambda s.~ M_1\subst{b}{\lambda s.~ M_2}\subst{b}{\lambda s.~ M_B}) ~s & (\beta)\\
            =& \quad \color{red}{\lambda s.~ M_1\subst{b}{\lambda s.~ M_2}\subst{b}{\lambda s.~ M_B}} & (\beta)
        \end{align*}
        \begin{align*}
            &\quad T\den{O_1;(O_2;B)} \\
            =& \quad \lambda s.~ E\den{O_1} ~T\den{O_2;B} ~s \\
            =& \quad \lambda s.~ E\den{O_1} ~(\lambda s. ~E\den{O_2} ~T\den{B} ~s) ~s \\
            =& \quad \lambda s.~ E\den{O_1} ~(\lambda s. ~E\den{O_2} ~T\den{B} ~s) ~s \\
            =& \quad \lambda s.~ E\den{O_1} ~(\lambda s. ~(\lambda b. \lambda s.~ M_2) ~T\den{B} ~s) ~s & (\cref{l-value})\\
            =& \quad \lambda s.~ E\den{O_1} ~(\lambda s. ~(\lambda b. \lambda s.~ M_2) ~(\lambda s.~ M_B) ~s) ~s & (\cref{l-value})\\
            =& \quad \lambda s.~ E\den{O_1} ~(\lambda s. ~(\lambda s.~ M_2\subst{b}{\lambda s.~ M_B}) ~s) ~s & (\beta) \\
            =& \quad \lambda s.~ E\den{O_1} ~(\lambda s. ~M_2\subst{b}{\lambda s.~ M_B}) ~s & (\beta)\\
            =& \quad \lambda s.~ (\lambda b. \lambda s.~ M_1) ~(\lambda s. ~M_2\subst{b}{\lambda s.~ M_B}) ~s & (\cref{l-value})\\
            =& \quad \lambda s.~ (\lambda s.~ M_1\subst{b}{\lambda s. ~M_2\subst{b}{\lambda s.~ M_B}}) ~s & (\beta)\\
            =& \quad \color{red}{\lambda s.~ M_1\subst{b}{\lambda s. ~M_2\subst{b}{\lambda s.~ M_B}}} & (\beta)
        \end{align*}
        \qed
    \end{proof}

\begin{lemma}[Extension Commit]
  \label{thm:ext-commit}
  $ E\den{\Do M; O} = E\den{\Do M}.$
\end{lemma}
    \begin{proof}
        \begin{align*}
            &\quad E\den{\Do M; O} \\
            =& \quad \lambda b. \lambda s.~ E\den{\Do M} ~(E\den{O} ~b) ~s \\
            =& \quad \lambda b. \lambda s.~ E\den{\Do M} ~((\lambda b. \lambda s.~ M_O) ~b) ~s & (\cref{l-value})\\
            =& \quad \lambda b. \lambda s.~ E\den{\Do M} ~(\lambda s.~ M_O) ~s & (\beta)\\
            =& \quad \lambda b. \lambda s.~ E\den{\Try \_ \to \Else \_ \to M} ~(\lambda s.~ M_O) ~s \\
            =& \quad \lambda b. \lambda s.~ (\lambda (x/\_). ~T\den{\Else \_ \to M}) ~(\lambda s.~ M_O) ~s \\
            =& \quad \lambda b. \lambda s.~ (T\den{\Else \_ \to M}) ~s & (\beta)\\
            =& \quad \lambda b. \lambda s.~ (T\den{\Continue \_ \to M}) ~s \\
            =& \quad \lambda b. \lambda s.~ (\lambda(x/\_) ~ \den{M}) ~s \\
            =& \quad \color{red}{\lambda b. \lambda s.~ \den{M}} & (\beta)
        \end{align*}
        \begin{align*}
            &\quad E\den{\Do M} \\
            =&\quad E\den{\Try \_ \to \Continue \_ \to M} \\
            =& \quad \lambda \_. ~T\den{\Continue \_ \to M} \\
            =& \quad \color{red}{\lambda \_. ~\lambda \_. ~  \den{M}}
        \end{align*}
        \qed
    \end{proof}

\begin{lemma}[Template Commit]
  \label{thm:template-commit}
  $ T\den{\Do M; B} = T\den{\Else M}.$
\end{lemma}
    \begin{proof}
        \begin{align*}
            &\quad T\den{\Else M} \\
            =&\quad T\den{\Continue \_ \to M} \\
            =&\quad \color{red}{\lambda \_. ~\den{M}} \\
        \end{align*}
        \begin{align*}
            &\quad E\den{\Do M} \\
            =&\quad E\den{\Try \_ \to \Continue \_ \to M} \\
            =& \quad \lambda \_. ~T\den{\Continue \_ \to M} \\
            =& \quad \lambda \_. ~\lambda \_. ~  \den{M}  
        \end{align*}
        \begin{align*}
            &\quad T\den{\Do M; B} \\
            =& \quad \lambda s. ~ E\den{\Do M} ~T\den{B} ~s \\
            =& \quad \lambda s. ~ (\lambda \_. ~\lambda \_. ~  \den{M}) ~T\den{B} ~s \\
            =& \quad \lambda s. ~ (\lambda \_. ~  \den{M}) ~s  & (\beta)\\
            =& \quad \color{red}{\lambda s. ~ \den{M}}  & (\beta)
        \end{align*}
        \qed
    \end{proof}

\begin{lemma}[$\eta\lamstar$]
  \label{thm:eta-lamstar}
  $E\den{\lambda x.~ (\lamstar (F; B)) ~ x} = E\den{\lamstar (F; B)}$
\end{lemma}
\begin{proof}
  From \cref{thm:value-translation}, we have
  $E\den{F} = \lambda b.\lambda s. \lambda z. M$ for some term $M$.  In the
  following, let
  $M' = M\subst{b}{T\den{B}}\subst{s}{(\lambda y.\mathit{self}~y)}$,
  \begin{align*}
    &\quad
    E\den{\lambda x.~ (\lamstar (F; B)) ~ x}
    \\
    =&\quad
    \lambda x. E\den{(\lamstar (F; B))} ~ x
    \\
    =&\quad
    \lambda x.
    (\Rec \mathit{self}
    = (\lambda s. E\den{F} ~ T\den{B} ~ s)
    ~ (\lambda y. \mathit{self}~y))
    ~ x
    \\
    =&\quad
    \lambda x.
    (\Rec \mathit{self} = E\den{F} ~ T\den{B} ~ (\lambda y. \mathit{self}~y))
    ~ x
    &(\beta)
    \\
    =&\quad
    \lambda x.
    (\Rec \mathit{self}
    = (\lambda b.\lambda s.\lambda z. M) ~ T\den{B}
    ~ (\lambda y. \mathit{self}~y))
    ~ x
    &(\cref{thm:value-translation})
    \\
    =&\quad
    \lambda x.
    (\Rec \mathit{self}
    = \lambda z. M\subst{b}{T\den{B}}\subst{s}{(\lambda y.\mathit{self}~y)})
    ~ x
    \\
    =&\quad
    \lambda x.
    (\Rec \mathit{self} = \lambda z. M')
    ~ x
    &(\beta)
    \\
    =&\quad
    \lambda x.
    (\lambda z.
    M'
    \subst{\mathit{self}}{\Rec \mathit{self} = \lambda z. M'})
    ~ x
    &(rec)
    \\
    =&\quad
    \lambda x.
    M'
    \subst{\mathit{self}}{\Rec \mathit{self} = \lambda z. M'}
    \subst{z}{x}
    &(\beta)
    \\
    =&\quad
    \lambda z.
    M'
    \subst{\mathit{self}}{\Rec \mathit{self} = \lambda z. M'}
    &(\alpha)
    \\
    =&\quad
    \Rec \mathit{self} = \lambda z. M'
    &(rec)
    \\
    =&\quad
    \Rec \mathit{self}
    = \lambda z. M\subst{b}{T\den{B}}\subst{s}{(\lambda y.\mathit{self}~y)}
    \\
    =&\quad
    \Rec \mathit{self}
    = (\lambda b. \lambda s. \lambda z. M) ~ T\den{B}
    ~ (\lambda x. \mathit{self} ~ x)
    &(\beta)
    \\
    =&\quad
    \Rec \mathit{self} = E\den{F} ~ T\den{B} ~ (\lambda x. \mathit{self} ~ x)
    &(\cref{thm:value-translation})
    \\
    =&\quad
    \Rec \mathit{self}
    = (\lambda s. E\den{F} ~ T\den{B} ~ s)
    ~ (\lambda x. \mathit{self} ~ x)
    &(\beta)
    \\
    =&\quad
    \Rec \mathit{self} = T\den{F; B} ~ (\lambda x. \mathit{self} ~ x)
    \\
    =&\quad
    E\den{\lamstar(F; B)}
  \end{align*}
  \qed
\end{proof}

\begin{lemma}[Unfold $\lamstar$]
  \label{thm:unfold-lamstar}
    $ E\den{ \lamstar (F; B)} = \den{(\Template F; B) ~ (\lamstar (F; B))}.$
\end{lemma}
\begin{proof}
  Note,
  \begin{math}
    T\den{F; B} ~ (\lambda x. \mathit{self} ~ x)
    =
    E\den{F} ~ T\den{B} ~ (\lambda x. \mathit{self} ~ x)    
  \end{math}
  is $\beta$-equal to some value of the form $\lambda z. M'$ because
  $T\den{F; B} = \lambda b. \lambda s. \lambda z. M$ from
  \cref{thm:value-translation}.  So
  $\Rec \mathit{self} = T\den{F; B} ~ (\lambda x. \mathit{self} ~ x)$ unfolds
  via $\beta$ and $rec$ in the following,
  \begin{align*}
    &\quad
    E\den{ \lamstar (F; B)}
    \\
    =& \quad
    (\Rec \mathit{self} = T\den{F; B} ~ (\lambda x. \mathit{self} ~ x))
    \\
    =& \quad
    T\den{F; B}
    ~
    (\lambda x.
    (\Rec \mathit{self} = T\den{F; B} ~ (\lambda x. \mathit{self} ~ x))
    ~ x)
    )
    & (\beta rec)
    \\
    =& \quad
    T\den{F; B} ~ (\lambda x. \den{\lamstar(F; B)} ~ x)
    \\
    =& \quad
    T\den{F; B} ~ \den{\lamstar(F; B)}
    & (\cref{thm:eta-lamstar})
    \\
    =& \quad
    \den{\Template (F; B)} ~ \den{\lamstar (F; B)}
    \\
    =& \quad
    \den{(\Template (F; B)) ~ (\lamstar (F; B))}
  \end{align*}
  \qed
\end{proof}

\begin{lemma}[Template Extension]
  \label{thm:templ-ext}
  \\
  $ \den{(\Template O; B) ~ V} = \den{(\Extension O) ~ (\Template B) ~ V}.$
\end{lemma}
    \begin{proof}
        \begin{align*}
            &\quad \den{(\Template O; B) ~ V} \\
            =& \quad \den{(\Template O; B)} ~ \den{V} \\
            =& \quad \den{(\Template O; B)} ~ W & (\cref{l-value}) \\
            =& \quad (\lambda s. ~E\den{O} ~T\den{B} ~s) ~ W \\
            =& \quad E\den{O} ~T\den{B} ~W
        \end{align*}
        \begin{align*}
            &\quad  \den{(\Extension O) ~ (\Template B) ~ V} \\
            =& \quad (\den{(\Extension O)} ~ \den{(\Template B)}) ~ \den{V} \\
            =& \quad (\den{(\Extension O)} ~ \den{(\Template B)}) ~ W & (\cref{l-value})\\
            =& \quad E\den{O} ~ T\den{B} ~ W
        \end{align*}
        \qed
    \end{proof}

\begin{lemma}[Template Failure]
  \label{thm:templ-fail}
  $ \den{(\Template \varepsilon) ~ V} = \den{\mathit{fail}~V}.$
\end{lemma}
    \begin{proof}
        \begin{align*}
            &\quad \den{(\Template \varepsilon) ~ V} \\
            =& \quad \den{(\Template \varepsilon)} ~ \den{V}\\
            =& \quad \den{(\Template \varepsilon)} ~ W & (\cref{l-value})\\
            =& \quad T\den{\varepsilon} ~ W \\
            =& \quad (\lambda s. ~fail ~s) ~ W \\
            =& \quad ~fail ~W 
        \end{align*}
        \begin{align*}
            &\quad \den{\mathit{fail}~V} \\
            =& \quad \den{\mathit{fail}} ~\den{V}\\
            =& \quad \den{\mathit{fail}} ~W  & (\cref{l-value})\\
            =& \quad \mathit{fail} ~W
        \end{align*}
        \qed
    \end{proof}

\begin{lemma}[Template Continue]
  \label{thm:templ-continue}
  $ \den{(\Template \Continue x \to M) ~ V} = \den{M\subst{x}{V}}.$
\end{lemma}
    \begin{proof}
        \begin{align*}
            &\quad \den{(\Template \Continue x \to M) ~ V} \\
            =& \quad T\den{(\Continue x \to M)} ~ \den{V}\\
            =& \quad T\den{(\Continue x \to M)} ~ W & (\cref{l-value})\\
            =& \quad (\lambda x. ~\den{M}) ~ W \\
            =& \quad \den{M}\subst{x}{W} & (\beta)
        \end{align*}
        \qed
    \end{proof}

\adriano{$\forall M V x, \den{M}\subst{x}{V} = \den{M\subst{x}{V}}$}

\begin{lemma}[Extension Try]
  \label{thm:ext-try}
    $ \den{(\Extension \Try x \to B) ~ V} = \Template B\subst{x}{V}.$
\end{lemma}
    \begin{proof}
        \begin{align*}
            &\quad \den{(\Extension \Try x \to B) ~ V}  \\
            =& \quad \den{(\Extension \Try x \to B)} ~ \den{V}\\
            =& \quad E\den{(\Try x \to B)} ~ \den{V}\\
            =& \quad (\lambda x. ~T\den{B}) ~ \den{V}\\
            =& \quad T\den{B}\subst{x}{\den{V}}
        \end{align*}
        \qed
    \end{proof}

\begin{lemma}[Try Match]
  \label{thm:try-match}
  \\
  $ \den{\Match P \gets V ~ O} = \den{O\subst{\many{x}}{\many{W}}} (\text{if } P\subst{\many{x}}{\many{W}} = V).$
\end{lemma}
    \begin{proof}
        \begin{align*}
            &\quad \den{\Match P \gets V ~ O}  \\
            =&\quad \lambda b. \lambda s.
            \begin{aligned}[t]
              &\Match \den{V} \With \\
              &\quad
              \begin{aligned}[t]
                \{~
                P &\to E\den{O}~b~s; \\
                \_ &\to b~s
                ~\}
              \end{aligned}
            \end{aligned}  \\
            =&\quad  \lambda b. \lambda s.~(E\den{O}~b~s)\subst{\many{x}}{\many{W}}  & (match) \\
            =&\quad  \lambda b. \lambda s.~((\lambda b. \lambda s. ~M_O)~b~s)\subst{\many{x}}{\many{W}}  & (\cref{l-value}) \\
            =&\quad  \lambda b. \lambda s.~M_O\subst{\many{x}}{\many{W}}  & (\beta)
        \end{align*}
        \begin{align*}
            &\quad \den{O\subst{\many{x}}{\many{W}}}  \\
            =& \quad \den{O}\subst{\many{x}}{\many{W}} \\
            =& \quad (\lambda b. \lambda s. ~M_O)\subst{\many{x}}{\many{W}} & (\cref{l-value}) \\
            =& \quad (\lambda b. \lambda s. ~M_O\subst{\many{x}}{\many{W}}) 
        \end{align*}
        \qed
    \end{proof}


%%% Local Variables:
%%% mode: LaTeX
%%% TeX-master: "coscheme"
%%% End:
