\adriano{Review the copattern case (probably use induction)}

\adriano{Figure out the correct argument to assure things about $\den{M}$'s}


\begin{proof}
    \Cref{l-value}.
    The following instances of translation are all values up to the equational theory of the target language in \cref{fig:target-equality}:

    The proof follows by mutual recursion/induction.
    \begin{enumerate}[(a)]
        \item $T\den{B} = \lambda s. M$ for some term $M$,
        \begin{proof}
            Let us consider the possible values of $B$.
            \begin{itemize}
                \item $(B = \varepsilon)$ By our translation we have: $T\den{\varepsilon} = \lambda s. ~\mathit{fail} ~s$, where $M=\mathit{fail} ~s$.
                \item ($B = O; B'$) By our translation we have: $T\den{O; B'} = \lambda s. ~\den{O} ~\den{B'} ~s$.
                    Our induction hypothesis provides us that $T\den{B'} = \lambda s. M'$ for some term $M'$.
                    By (b) we know that $E\den{O}=\lambda b. \lambda s. M_O$ for some term $M_O$.
                    \begin{align*}
                        & \quad \lambda s. ~\den{O} ~\den{B'} ~s \\
                        =& \quad \lambda s.  ~(\lambda b. \lambda s. M_O) ~(\lambda s. M') ~s & (IH, (b))
                    \end{align*}
                    Where $M=M'' ~(\lambda b. \lambda s. M_O) ~(\lambda s. M') ~s$.
                    \item $(B = \Continue x \to M')$ 
                    \begin{align*}
                        & \quad T\den{\Continue x \to M'} = \lambda x. ~\den{M}' \\
                        =& \quad \lambda x. ~(\lambda s. ~M'') & (\cref{l-trans-terms}) \\
                        =& \quad \lambda s. ~(\lambda s. ~M'') \subst{x}{s} & (=_{\alpha})
                    \end{align*} 
            \end{itemize}
            \qed
        \end{proof}
\item $E\den{O} = \lambda b. \lambda s. M$ for some term $M$,
\begin{proof}
    Let us consider the possible values of $O$.
    \begin{itemize}
    \item $(O = \varepsilon)$ By our translation we have $E\den{\varepsilon} = \lambda b. \lambda s. ~b ~s$, where $M= b ~s$.
    \item $(O = O_1;O_2)$
        \begin{align*}
            & \quad E\den{O_1;O_2} = \lambda b. \lambda s. ~\den{O_1} ~(\den{O_2} ~b) ~s\\
            =& \quad \lambda b. \lambda s. ~(\lambda b. \lambda s. ~M_{O_1}) ~((\lambda b. \lambda s. ~M_{O_2}) ~b) ~s & (IH)
        \end{align*}
        Where $M=(\lambda b. \lambda s. ~M_{O_1}) ~((\lambda b. \lambda s. ~M_{O_2}) ~b) ~s$.
    \item $(O = Q[x] ~O)$ Let us consider each possible value of $Q$.
        \begin{itemize}
            \item $(Q=\hole)$ According to our translation: $E\den{\hole ~ [x] ~O} = E\den{x ~O} = \lambda b. \lambda x. E\den{O} ~ b ~ x$.
            By our induction hypothesis we can infer that $E\den{O}=\lambda b. \lambda s. M_O$.
            Therefore, we can conclude that $\lambda b. \lambda x. ~(\lambda b. \lambda s. M_O) ~ b ~ x$, where $ M = (\lambda b. \lambda s. M_O) ~ b ~ x$.
            \item $Q=(Q ~P)$ According to our translation: $E\den{(Q ~P) ~ [x] ~O} = E\den{(Q[x] ~P) ~O} = E\den{Q[x] ~ (\lambda P. O)}$.
            Eventually, we will hit the previous case after converting all patterns in the copattern into pattern $\lambda$'s.
            After converting all patterns $O$ will have a shape of form: $\lambda P_0. ~\lambda P_1 ... \lambda P_n. ~O$.
            \adriano{I think I need to use induction here.}
        \end{itemize}
    \item $(O = \lambda P. ~O)$ According to our translation:
        \begin{align*} 
            & \quad E\den{\lambda P. ~O} = E\den{\lambda x. \Match P \gets x ~ O}\\
            =& \quad \lambda b. \lambda s. (\lambda x. E\den{\Match P \gets x ~ O} ~ (\lambda s'. b ~ s' ~ x) ~ s) \\
            =& \quad \lambda b. \lambda s. (\lambda x. \lambda b. \lambda s. (
            \begin{aligned}[t]
              &\Match \den{M} \With \\
              &\quad
              \begin{aligned}[t]
                \{~
                P &\to E\den{O}~b~s; \\
                \_ &\to b~s
                ~\}
              \end{aligned}
            \end{aligned}
            )~ (\lambda s'. b ~ s' ~ x) ~ s) \\
            =& \quad \lambda b. \lambda s. (\lambda x. \lambda b. \lambda s. (
            \begin{aligned}[t]
              &\Match \den{M} \With \\
              &\quad
              \begin{aligned}[t]
                \{~
                P &\to (\lambda b. \lambda s. M_O)~b~s; \\
                \_ &\to b~s
                ~\}
              \end{aligned}
            \end{aligned}
            )~ (\lambda s'. b ~ s' ~ x) ~ s) & (IH)
            \end{align*}
    \item $(O = \Match P \gets M ~ O)$
        \begin{align*}
            & \quad E\den{\Match P \gets M ~ O} = \lambda b. \lambda s.
            \begin{aligned}[t]
              &\Match \den{M} \With \\
              &\quad
              \begin{aligned}[t]
                \{~
                P &\to E\den{O}~b~s; \\
                \_ &\to b~s
                ~\}
              \end{aligned}
            \end{aligned} \\
            =& \quad \lambda b. \lambda s.
            \begin{aligned}[t]
              &\Match M' \With \\
              &\quad
              \begin{aligned}[t]
                \{~
                P &\to (\lambda b. \lambda s.~ M_O) ~b~s; \\
                \_ &\to b~s
                ~\}
              \end{aligned}
            \end{aligned}  & (IH, \cref{l-trans-terms})
            \end{align*}
    \item $(O = \Nest O)$
        \begin{align*}
            & \quad E\den{\Nest O} = \lambda b. \lambda s. \Rec s' = E\den{O} ~ (\lambda \_. b ~ s) ~ (\lambda x. s' ~ x)\\
            =& \quad \lambda b. \lambda s. \Rec s' = (\lambda b. \lambda s.~ M_O) ~ (\lambda \_. b ~ s) ~ (\lambda x. s' ~ x) & (IH)
        \end{align*}
    \item $(O = \Try x \to B)$ 
        \begin{align*}
            & \quad E\den{\Try x \to B} = \lambda x. T\den{B}\\
            =& \quad \lambda x. (\lambda s.~ M_B) & (a) \\
            =& \quad \lambda b. (\lambda s.~ M_B)\subst{x}{b} & (=_{\alpha})
        \end{align*}
    \end{itemize}
    \qed
\end{proof}
\item $E\den{F} = \lambda b. \lambda s. \lambda x. M$ for some term $M$,
\begin{proof}
    Let us consider the possible values of $F$.
    \begin{itemize}
        \item $(F= \lambda P. ~O)$ Let' consider if $P$ is a variable pattern or not:
        \begin{itemize}
            \item $(P = x)$ According to our translation $E\den{\lambda x. ~O}=\lambda b. \lambda s. (\lambda x. E\den{O} ~ (\lambda s'. b ~ s' ~ x) ~ s)$.
            Therefore, by (b), we can conclude that $\lambda b. \lambda s. (\lambda x. (\lambda b. \lambda s. M_O) ~ (\lambda s'. b ~ s' ~ x) ~ s)$
            \item $(P \neq x)$ We have that $E\den{\lambda P. ~O}=E\den{\lambda x. \Match P \gets x ~ O}$ which is a specific case of the previous case, where $O=\Match P \gets x ~ O$.
        \end{itemize} 
        \item $(F= Q[x ~P] ~O)$ Eventually, after converting the whole copattern we will hit $E\den{x ~O}$, where $O$ is some sequence of nested $\lambda P$'s.
        \begin{align*}
            & \quad E\den{x ~O} =  \lambda b. \lambda x. E\den{\lambda P. O'} ~ b ~ x\\
            =& \quad \lambda b. \lambda x. (\lambda b. \lambda s. \lambda x. M') ~ b ~ x & (IH) \\
            =& \quad \lambda b. \lambda x. (\lambda x. M'\subst{s}{x}) & (\beta) \\
            =& \quad \lambda b. \lambda s. (\lambda x. M'\subst{s}{x})\subst{x}{s} & (\alpha)
        \end{align*}
    \end{itemize}
    \qed
\end{proof}
\item $\den{V} = W$ for some value $W$.
\begin{proof}
    By induction on $V$.
    \begin{itemize}
        \item $\den{x} = x$, where $W=x$.
        \item \begin{align*}
            & \quad \den{\lambda x. ~M} = \lambda x. ~\den{M} \\
            =& \quad \lambda x. ~M'' & (\cref{l-trans-terms})
        \end{align*}
        where $W = \lambda x. ~M''$.
        \item $\den{null} = null$, where $W=null$.
        \item \begin{align*}
            & \quad \den{\Cons V \, W} = \Cons \den{V_1} \, \den{V_2} \\
            =& \quad \Cons V_1' \, V_2' & (IH)
        \end{align*}
        where $W = \Cons \den{V_1'} \, \den{V_2'}$.
        \item $\den{x'} = x'$, where $W=x'$.
        \item \begin{align*}
            & \quad \den{\lamstar B} = \Rec \mathit{self} = T\den{B} ~ (\lambda x. \mathit{self} ~ x) \\
            =& \quad \Rec \mathit{self} = (\lambda s. ~M_B) ~ (\lambda x. \mathit{self} ~ x) & (a)
        \end{align*}
        \item \begin{align*}
            & \quad \den{\Template B} = T\den{B} \\
            =& \quad \lambda s. M_B& (a)
        \end{align*}
        \item \begin{align*}
            & \quad \den{\Extension O} = E\den{O} \\
            =& \quad \lambda b. \lambda s. M_O& (b)
        \end{align*}
    \end{itemize}
    \qed
\end{proof}
\end{enumerate}

\end{proof}

\begin{theorem}[Extension Composition Identity Left]
    $ E\den{\varepsilon; O} = E\den{O}.$
    \begin{proof}
        \begin{align*}
            &\quad E\den{\varepsilon; O} \\
            =& \quad \lambda b. \lambda s.~ E\den{\varepsilon} ~(E\den{O} ~b) ~s \\
            =&  \quad \lambda b. \lambda s.~ E\den{\varepsilon} ~((\lambda b. \lambda s.~ M_0) ~b) ~s & (\cref{l-value})\\
            =& \quad \lambda b. \lambda s.~ (\lambda b. \lambda s.~ b ~s) ~((\lambda b. \lambda s.~ M_0) ~b) ~s \\
            =& \quad \lambda b. \lambda s.~ (\lambda b. \lambda s.~ b ~s) ~(\lambda s.~ M_0) ~s & (\beta)\\
            =& \quad \lambda b. \lambda s.~ (\lambda s.~ (\lambda s.~ M_0) ~s) ~s & (\beta)\\
            =& \quad \lambda b. \lambda s.~ (\lambda s.~ M_0) ~s & (\beta)\\
            =& \quad \lambda b. \lambda s.~ M_0 & (\beta) \\
            =& \quad E\den{O} & (\cref{l-value})
        \end{align*}
        \qed
    \end{proof}
\end{theorem}

\begin{theorem}[Extension Composition Identity Right]
    $ E\den{O} = E\den{O;\varepsilon}.$
    \begin{proof}
        \begin{align*}
            &\quad E\den{O;\varepsilon} \\
            =& \quad \lambda b. \lambda s.~ E\den{O} ~(E\den{\varepsilon} ~b) ~s \\
            =& \quad \lambda b. \lambda s.~ E\den{O} ~((\lambda b. \lambda s.~ b ~s) ~b) ~s \\
            =& \quad \lambda b. \lambda s.~ E\den{O} ~(\lambda s.~ b ~s) ~s & (\beta)\\
            =& \quad \lambda b. \lambda s.~ (\lambda b. \lambda s.~ M_0) ~(\lambda s.~ b ~s) ~s & (\cref{l-value})\\
            =& \quad \color{red}{\lambda b. \lambda s.~ (\lambda b. \lambda s.~ M_0) ~b ~s} & \color{red}{(\eta)}\\
            =& \quad \color{red}{\lambda b. \lambda s.~ (\lambda s.~ M_0) ~s} & (\beta)\\
            =& \quad \color{red}{\lambda b. \lambda s.~ M_0} & (\beta) \\
            =& \quad \color{red}{E\den{O}} & (\cref{l-value})
        \end{align*}
        \qed
    \end{proof}
\end{theorem}

\begin{theorem}[Template Composition Identity Left]
    $ T\den{\varepsilon; B} = T\den{B}.$
    \begin{proof}
        \begin{align*}
            &\quad T\den{\varepsilon; B} \\
            =& \quad \lambda s. ~ E\den{\varepsilon} ~T\den{B} ~s \\
            =& \quad \lambda s. ~ (\lambda b. \lambda s.~ b ~s) ~T\den{B} ~s \\
            =& \quad \lambda s. ~ (\lambda b. \lambda s.~ b ~s) ~(\lambda s.~ M_0) ~s & (\cref{l-value})\\
            =& \quad \lambda s. ~ (\lambda s.~ (\lambda s.~ M_0) ~s) ~s & (\beta)\\
            =& \quad \lambda s. ~ (\lambda s.~ M_0) ~s & (\beta)\\
            =& \quad \lambda s. ~ M_0 & (\beta) \\
            =& \quad T\den{B} & (\cref{l-value})
        \end{align*}
        \qed
    \end{proof}
\end{theorem}

\begin{theorem}[Extension Composition Associativity]
    $ E\den{(O_1;O_2);O_3} = E\den{O_1;(O_2;O_3)}.$
    \begin{proof}
        \begin{align*}
            &\quad E\den{(O_1;O_2);O_3} \\
            =& \quad \lambda b. \lambda s.~ E\den{O_1;O_2} ~(E\den{O_3} ~b) ~s \\
            =& \quad \lambda b. \lambda s.~ (\lambda b. \lambda s.~ E\den{O_1} ~(E\den{O_2} ~b) ~s) ~(E\den{O_3} ~b) ~s \\
            =& \quad \lambda b. \lambda s.~ (\lambda b. \lambda s.~ E\den{O_1} ~(E\den{O_2} ~b) ~s) ~((\lambda b. \lambda s.~ M_3) ~b) ~s & (\cref{l-value})\\
            =& \quad \lambda b. \lambda s.~ (\lambda b. \lambda s.~ E\den{O_1} ~(E\den{O_2} ~b) ~s) ~(\lambda s.~ M_3) ~s & (\beta)\\
            =& \quad \lambda b. \lambda s.~ (\lambda b. \lambda s.~ (\lambda b. \lambda s.~ M_1) ~(E\den{O_2} ~b) ~s) ~(\lambda s.~ M_3) ~s & (\cref{l-value})\\
            =& \quad \lambda b. \lambda s.~ (\lambda b. \lambda s.~ (\lambda b. \lambda s.~ M_1) ~((\lambda b. \lambda s.~ M_2) ~b) ~s) ~(\lambda s.~ M_3) ~s & (\cref{l-value})\\
            =& \quad \lambda b. \lambda s.~ (\lambda b. \lambda s.~ (\lambda b. \lambda s.~ M_1) ~(\lambda s.~ M_2) ~s) ~(\lambda s.~ M_3) ~s & (\beta) \\
            =& \quad \lambda b. \lambda s.~ (\lambda b. \lambda s.~ (\lambda s.~ M_1\subst{b}{\lambda s.~ M_2}) ~s) ~(\lambda s.~ M_3) ~s & (\beta) \\
            =& \quad \lambda b. \lambda s.~ (\lambda s.~ (\lambda s.~ M_1\subst{b}{\lambda s.~ M_2}\subst{b}{\lambda s.~ M_3}) ~s) ~s & (\beta) \\
            =& \quad \lambda b. \lambda s.~ (\lambda s.~ M_1\subst{b}{\lambda s.~ M_2}\subst{b}{\lambda s.~ M_3}) ~s & (\beta) \\
            =& \quad \lambda b. \lambda s.~ \color{red}{M_1\subst{b}{\lambda s.~ M_2}\subst{b}{\lambda s.~ M_3}} & (\beta)
        \end{align*}

        \begin{align*}
            &\quad E\den{O_1;(O_2;O_3)} \\
            =& \quad \lambda b. \lambda s.~ E\den{O_1} ~(\den{O_2;O_3} ~b) ~s \\
            =& \quad \lambda b. \lambda s.~ E\den{O_1} ~((\lambda b. \lambda s.~ E\den{O_2} ~(E\den{O_3} ~b) ~s) ~b) ~s \\
            =& \quad \lambda b. \lambda s.~ E\den{O_1} ~(\lambda s.~ E\den{O_2} ~(E\den{O_3} ~b) ~s) ~s & (\beta) \\
            =& \quad \lambda b. \lambda s.~ (\lambda b. \lambda s.~ M_1) ~(\lambda s.~ E\den{O_2} ~(E\den{O_3} ~b) ~s) ~s & (\cref{l-value})\\
            =& \quad \lambda b. \lambda s.~ (\lambda b. \lambda s.~ M_1) ~(\lambda s.~ (\lambda b. \lambda s.~ M_2) ~(E\den{O_3} ~b) ~s) ~s & (\cref{l-value})\\
            =& \quad \lambda b. \lambda s.~ (\lambda b. \lambda s.~ M_1) ~(\lambda s.~ (\lambda b. \lambda s.~ M_2) ~((\lambda b. \lambda s.~ M_3) ~b) ~s) ~s & (\cref{l-value})\\
            =& \quad \lambda b. \lambda s.~ (\lambda b. \lambda s.~ M_1) ~(\lambda s.~ (\lambda b. \lambda s.~ M_2) ~(\lambda s.~ M_3) ~s) ~s & (\beta)\\
            =& \quad \lambda b. \lambda s.~ (\lambda b. \lambda s.~ M_1) ~(\lambda s.~ (\lambda s.~ M_2\subst{b}{\lambda s.~ M_3}) ~s) ~s & (\beta)\\
            =& \quad \lambda b. \lambda s.~ (\lambda b. \lambda s.~ M_1) ~(\lambda s.~ M_2\subst{b}{\lambda s.~ M_3}) ~s & (\beta)\\
            =& \quad \lambda b. \lambda s.~ (\lambda s.~ M_1\subst{b}{\lambda s.~ M_2\subst{b}{\lambda s.~ M_3}}) ~s & (\beta)\\
            =& \quad \lambda b. \lambda s.~ \color{red}{M_1\subst{b}{\lambda s.~ M_2\subst{b}{\lambda s.~ M_3}}} & (\beta)
        \end{align*}
        \qed
    \end{proof}
\end{theorem}

\begin{theorem}[Template Composition Associativity]

    $ T\den{(O_1;O_2);B} = T\den{O_1;(O_2;B)}.$
    \begin{proof}
        \begin{align*}
            &\quad T\den{(O_1;O_2);B} \\
            =& \quad \lambda s.~ E\den{O_1;O_2} ~T\den{B} ~s \\
            =& \quad \lambda s.~ (\lambda b. \lambda s.~ E\den{O_1} ~(E\den{O_2} ~b) ~s) ~T\den{B} ~s \\
            =& \quad \lambda s.~ (\lambda b. \lambda s.~ (\lambda b. \lambda s.~ M_1) ~(E\den{O_2} ~b) ~s) ~T\den{B} ~s & (\cref{l-value})\\
            =& \quad \lambda s.~ (\lambda b. \lambda s.~ (\lambda b. \lambda s.~ M_1) ~((\lambda b. \lambda s.~ M_2) ~b) ~s) ~T\den{B} ~s & (\cref{l-value})\\
            =& \quad \lambda s.~ (\lambda b. \lambda s.~ (\lambda b. \lambda s.~ M_1) ~(\lambda s.~ M_2) ~s) ~T\den{B} ~s & (\beta)\\
            =& \quad \lambda s.~ (\lambda b. \lambda s.~ (\lambda s.~ M_1\subst{b}{\lambda s.~ M_2}) ~s) ~T\den{B} ~s & (\beta)\\
            =& \quad \lambda s.~ (\lambda b. \lambda s.~ M_1\subst{b}{\lambda s.~ M_2}) ~T\den{B} ~s & (\beta)\\
            =& \quad \lambda s.~ (\lambda b. \lambda s.~ M_1\subst{b}{\lambda s.~ M_2}) ~(\lambda s.~ M_B) ~s & (\cref{l-value})\\
            =& \quad \lambda s.~ (\lambda s.~ M_1\subst{b}{\lambda s.~ M_2}\subst{b}{\lambda s.~ M_B}) ~s & (\beta)\\
            =& \quad \color{red}{\lambda s.~ M_1\subst{b}{\lambda s.~ M_2}\subst{b}{\lambda s.~ M_B}} & (\beta)
        \end{align*}
        \begin{align*}
            &\quad T\den{O_1;(O_2;B)} \\
            =& \quad \lambda s.~ E\den{O_1} ~T\den{O_2;B} ~s \\
            =& \quad \lambda s.~ E\den{O_1} ~(\lambda s. ~E\den{O_2} ~T\den{B} ~s) ~s \\
            =& \quad \lambda s.~ E\den{O_1} ~(\lambda s. ~E\den{O_2} ~T\den{B} ~s) ~s \\
            =& \quad \lambda s.~ E\den{O_1} ~(\lambda s. ~(\lambda b. \lambda s.~ M_2) ~T\den{B} ~s) ~s & (\cref{l-value})\\
            =& \quad \lambda s.~ E\den{O_1} ~(\lambda s. ~(\lambda b. \lambda s.~ M_2) ~(\lambda s.~ M_B) ~s) ~s & (\cref{l-value})\\
            =& \quad \lambda s.~ E\den{O_1} ~(\lambda s. ~(\lambda s.~ M_2\subst{b}{\lambda s.~ M_B}) ~s) ~s & (\beta) \\
            =& \quad \lambda s.~ E\den{O_1} ~(\lambda s. ~M_2\subst{b}{\lambda s.~ M_B}) ~s & (\beta)\\
            =& \quad \lambda s.~ (\lambda b. \lambda s.~ M_1) ~(\lambda s. ~M_2\subst{b}{\lambda s.~ M_B}) ~s & (\cref{l-value})\\
            =& \quad \lambda s.~ (\lambda s.~ M_1\subst{b}{\lambda s. ~M_2\subst{b}{\lambda s.~ M_B}}) ~s & (\beta)\\
            =& \quad \color{red}{\lambda s.~ M_1\subst{b}{\lambda s. ~M_2\subst{b}{\lambda s.~ M_B}}} & (\beta)
        \end{align*}
        \qed
    \end{proof}
\end{theorem}

\begin{theorem}[Extension Commit]
    $ E\den{\Do M; O} = E\den{\Do M}.$
    \begin{proof}
        \begin{align*}
            &\quad E\den{\Do M; O} \\
            =& \quad \lambda b. \lambda s.~ E\den{\Do M} ~(E\den{O} ~b) ~s \\
            =& \quad \lambda b. \lambda s.~ E\den{\Do M} ~((\lambda b. \lambda s.~ M_O) ~b) ~s & (\cref{l-value})\\
            =& \quad \lambda b. \lambda s.~ E\den{\Do M} ~(\lambda s.~ M_O) ~s & (\beta)\\
            =& \quad \lambda b. \lambda s.~ E\den{\Try \_ \to \Else \_ \to M} ~(\lambda s.~ M_O) ~s \\
            =& \quad \lambda b. \lambda s.~ (\lambda (x/\_). ~T\den{\Else \_ \to M}) ~(\lambda s.~ M_O) ~s \\
            =& \quad \lambda b. \lambda s.~ (T\den{\Else \_ \to M}) ~s & (\beta)\\
            =& \quad \lambda b. \lambda s.~ (T\den{\Continue \_ \to M}) ~s \\
            =& \quad \lambda b. \lambda s.~ (\lambda(x/\_) ~ \den{M}) ~s \\
            =& \quad \color{red}{\lambda b. \lambda s.~ \den{M}} & (\beta)
        \end{align*}
        \begin{align*}
            &\quad E\den{\Do M} \\
            =&\quad E\den{\Try \_ \to \Continue \_ \to M} \\
            =& \quad \lambda \_. ~T\den{\Continue \_ \to M} \\
            =& \quad \color{red}{\lambda \_. ~\lambda \_. ~  \den{M}}
        \end{align*}
        \qed
    \end{proof}
\end{theorem}

\begin{theorem}[Template Commit]
    $ T\den{\Do M; B} = T\den{\Else M}.$
    \begin{proof}
        \begin{align*}
            &\quad T\den{\Else M} \\
            =&\quad T\den{\Continue \_ \to M} \\
            =&\quad \color{red}{\lambda \_. ~\den{M}} \\
        \end{align*}
        \begin{align*}
            &\quad E\den{\Do M} \\
            =&\quad E\den{\Try \_ \to \Continue \_ \to M} \\
            =& \quad \lambda \_. ~T\den{\Continue \_ \to M} \\
            =& \quad \lambda \_. ~\lambda \_. ~  \den{M}  
        \end{align*}
        \begin{align*}
            &\quad T\den{\Do M; B} \\
            =& \quad \lambda s. ~ E\den{\Do M} ~T\den{B} ~s \\
            =& \quad \lambda s. ~ (\lambda \_. ~\lambda \_. ~  \den{M}) ~T\den{B} ~s \\
            =& \quad \lambda s. ~ (\lambda \_. ~  \den{M}) ~s  & (\beta)\\
            =& \quad \color{red}{\lambda s. ~ \den{M}}  & (\beta)
        \end{align*}
        \qed
    \end{proof}
\end{theorem}

\begin{theorem}[Unfold $\lamstar$]
    $ E\den{ \lamstar (F; B)} = \den{(\Template F; B) ~ (\lamstar (F; B))}.$
    \begin{proof}
        \begin{align*}
            &\quad E\den{ \lamstar (F; B)} \\
            =& \quad (\Rec \mathit{self} = T\den{F; B} ~ (\lambda x. \mathit{self} ~ x)) \\
            =& \quad (\Rec \mathit{self} = T\den{F; B} ~ \mathit{self}) & \color{red}{(\eta)}\\
            =& \quad (\Rec \mathit{self} = (\lambda s. ~E\den{F} ~T\den{B} ~s) ~  \mathit{self}) \\
            % =& \quad (\Rec \mathit{self} = (\lambda s. ~E\den{F} ~T\den{B} ~s) ~ (\mathit{self}) & (\eta) \\
            =& \quad (\Rec \mathit{self} = ~E\den{F}\subst{s}{\mathit{self}} ~T\den{B}\subst{s}{\mathit{self}} ~\mathit{self}) & (\beta)\\
            % =& \quad (\Rec \mathit{self} = ~E\den{F}\subst{s}{self} ~T\den{B}\subst{s}{self} ~(self) & (\beta)\\
            =& \quad (E\den{F}\subst{s}{\mathit{self}} ~T\den{B}\subst{s}{\mathit{self}} ~\mathit{self})\subst{self}{(\Rec \mathit{self} = ~E\den{F}\subst{s}{\mathit{self}} ~T\den{B}\subst{s}{\mathit{self}} ~\mathit{self})} & (rec)\\
            =& \quad (E\den{F}\subst{s}{\mathit{self}} ~T\den{B}\subst{s}{\mathit{self}} ~\mathit{self})\subst{self}{E\den{ \lamstar (F; B)}} & (rec)\\
            =& \quad (E\den{F}\subst{s}{E\den{ \lamstar (F; B)}} ~T\den{B}\subst{s}{E\den{ \lamstar (F; B)}} ~E\den{ \lamstar (F; B)})& (\beta)
        \end{align*}
        \begin{align*}
            &\quad \den{(\Template F; B) ~ (\lamstar (F; B))} \\
            =& \quad \den{(\Template F; B)} ~\den{(\lamstar (F; B))} \\
            =& \quad E\den{(F; B)} ~E\den{(\lamstar (F; B))} \\
            =& \quad (\lambda s. ~E\den{F} ~T\den{B} ~s) ~E\den{(\lamstar (F; B))} \\
            =& \quad ~E\den{F}\subst{s}{E\den{(\lamstar (F; B))}} ~T\den{B}\subst{s}{E\den{(\lamstar (F; B))}} ~E\den{(\lamstar (F; B))}  & (\beta)
        \end{align*}
        \qed
    \end{proof}
\end{theorem}

\begin{theorem}[] \\
    $ \den{(\Template O; B) ~ V} = \den{(\Extension O) ~ (\Template B) ~ V}.$
    \begin{proof}
        \begin{align*}
            &\quad \den{(\Template O; B) ~ V} \\
            =& \quad \den{(\Template O; B)} ~ \den{V} \\
            =& \quad \den{(\Template O; B)} ~ W & (\cref{l-value}) \\
            =& \quad (\lambda s. ~E\den{O} ~T\den{B} ~s) ~ W \\
            =& \quad E\den{O} ~T\den{B} ~W
        \end{align*}
        \begin{align*}
            &\quad  \den{(\Extension O) ~ (\Template B) ~ V} \\
            =& \quad (\den{(\Extension O)} ~ \den{(\Template B)}) ~ \den{V} \\
            =& \quad (\den{(\Extension O)} ~ \den{(\Template B)}) ~ W & (\cref{l-value})\\
            =& \quad E\den{O} ~ T\den{B} ~ W
        \end{align*}
        \qed
    \end{proof}
\end{theorem}

\begin{theorem}[] \\
    $ \den{(\Template \varepsilon) ~ V} = \den{\mathit{fail}~V}.$
    \begin{proof}
        \begin{align*}
            &\quad \den{(\Template \varepsilon) ~ V} \\
            =& \quad \den{(\Template \varepsilon)} ~ \den{V}\\
            =& \quad \den{(\Template \varepsilon)} ~ W & (\cref{l-value})\\
            =& \quad T\den{\varepsilon} ~ W \\
            =& \quad (\lambda s. ~fail ~s) ~ W \\
            =& \quad ~fail ~W 
        \end{align*}
        \begin{align*}
            &\quad \den{\mathit{fail}~V} \\
            =& \quad \den{\mathit{fail}} ~\den{V}\\
            =& \quad \den{\mathit{fail}} ~W  & (\cref{l-value})\\
            =& \quad \mathit{fail} ~W
        \end{align*}
        \qed
    \end{proof}
\end{theorem}

\begin{theorem}[]
    $ \den{(\Template \Continue x \to M) ~ V} = \den{M\subst{x}{V}}.$
    \begin{proof}
        \begin{align*}
            &\quad \den{(\Template \Continue x \to M) ~ V} \\
            =& \quad T\den{(\Continue x \to M)} ~ \den{V}\\
            =& \quad T\den{(\Continue x \to M)} ~ W & (\cref{l-value})\\
            =& \quad (\lambda x. ~\den{M}) ~ W \\
            =& \quad \den{M}\subst{x}{W} & (\beta)
        \end{align*}
        \qed
    \end{proof}
\end{theorem}

\adriano{$\forall M V x, \den{M}\subst{x}{V} = \den{M\subst{x}{V}}$}

\begin{theorem}[]
    $ \den{(\Extension \Try x \to B) ~ V} = \Template B\subst{x}{V}.$
    \begin{proof}
        \begin{align*}
            &\quad \den{(\Extension \Try x \to B) ~ V}  \\
            =& \quad \den{(\Extension \Try x \to B)} ~ \den{V}\\
            =& \quad E\den{(\Try x \to B)} ~ \den{V}\\
            =& \quad (\lambda x. ~T\den{B}) ~ \den{V}\\
            =& \quad T\den{B}\subst{x}{\den{V}}
        \end{align*}
        \qed
    \end{proof}
\end{theorem}

\begin{theorem}[] \\
    $ \den{\Match P \gets V ~ O} = \den{O\subst{\many{x}}{\many{W}}} (\text{if } P\subst{\many{x}}{\many{W}} = V).$
    \begin{proof}
        \begin{align*}
            &\quad \den{\Match P \gets V ~ O}  \\
            =&\quad \lambda b. \lambda s.
            \begin{aligned}[t]
              &\Match \den{V} \With \\
              &\quad
              \begin{aligned}[t]
                \{~
                P &\to E\den{O}~b~s; \\
                \_ &\to b~s
                ~\}
              \end{aligned}
            \end{aligned}  \\
            =&\quad  \lambda b. \lambda s.~(E\den{O}~b~s)\subst{\many{x}}{\many{W}}  & (match) \\
            =&\quad  \lambda b. \lambda s.~((\lambda b. \lambda s. ~M_O)~b~s)\subst{\many{x}}{\many{W}}  & (\cref{l-value}) \\
            =&\quad  \lambda b. \lambda s.~M_O\subst{\many{x}}{\many{W}}  & (\beta)
        \end{align*}
        \begin{align*}
            &\quad \den{O\subst{\many{x}}{\many{W}}}  \\
            =& \quad \den{O}\subst{\many{x}}{\many{W}} \\
            =& \quad (\lambda b. \lambda s. ~M_O)\subst{\many{x}}{\many{W}} & (\cref{l-value}) \\
            =& \quad (\lambda b. \lambda s. ~M_O\subst{\many{x}}{\many{W}}) 
        \end{align*}
        \qed
    \end{proof}
\end{theorem}
